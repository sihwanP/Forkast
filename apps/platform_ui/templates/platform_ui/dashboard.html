{% extends 'platform_ui/base.html' %}
{% load static humanize %}

{% block title %}í¬ì¹´ìŠ¤íŠ¸ AI ì»¨ì„¤íŒ… ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block extra_css %}
<style>
    /* 1. Theme Variables (Default: Light Mode) */
    :root {
        --dash-bg: #f8fafc;
        --dash-text: #0f172a;
        --glass-bg: rgba(255, 255, 255, 0.7);
        --glass-border: rgba(0, 0, 0, 0.05);
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --accent-blue: #3b82f6;
        --accent-emerald: #10b981;
        --kpi-label: #64748b;
        --kpi-value: #0f172a;
        --hero-gradient: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        --hero-border: rgba(59, 130, 246, 0.1);
    }

    /* 2. Dark Mode Overrides */
    body.dark-mode {
        --dash-bg: #020617;
        --dash-text: #f8fafc;
        --glass-bg: rgba(15, 23, 42, 0.6);
        --glass-border: rgba(255, 255, 255, 0.1);
        --card-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.5);
        --kpi-label: #94a3b8;
        --kpi-value: #f8fafc;
        --hero-gradient: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        --hero-border: rgba(59, 130, 246, 0.2);
    }

    /* 3. Base Styles */
    body {
        background: var(--dash-bg) !important;
        color: var(--dash-text) !important;
        overflow-y: auto !important;
        transition: background 0.3s, color 0.3s;
    }

    /* Bento Grid Layout */
    .bento-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-auto-rows: minmax(160px, auto);
        gap: 1.5rem;
        padding: 2rem;
        max-width: 1600px;
        margin: 0 auto;
    }

    .bento-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 2rem;
        padding: 1.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: var(--card-shadow);
    }

    .bento-card:hover {
        transform: translateY(-5px);
        border-color: rgba(59, 130, 246, 0.3);
        box-shadow: 0 20px 40px -10px rgba(59, 130, 246, 0.15);
    }

    /* KPI Cards */
    .kpi-title { font-size: 0.875rem; font-weight: 700; color: var(--kpi-label); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .kpi-value { font-size: 2.25rem; font-weight: 900; color: var(--kpi-value); letter-spacing: -0.02em; }
    .kpi-delta { font-size: 0.875rem; font-weight: 600; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.25rem; }
    .delta-up { color: #10b981; }
    .delta-down { color: #ef4444; }

    /* Special Cards */
    .card-span-2 { grid-column: span 2; }
    .card-row-2 { grid-row: span 2; }
    .card-hero { 
        grid-column: span 4; 
        background: var(--hero-gradient); 
        min-height: 240px; 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        border: 1px solid var(--hero-border);
    }

    /* AI Insight Section */
    .ai-insight-badge { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 800; }
    .strategy-item { 
        background: rgba(var(--accent-blue-rgb), 0.05); 
        border-left: 4px solid var(--accent-blue); 
        padding: 1rem; 
        border-radius: 0.75rem; 
        margin-top: 1rem; 
    }
    
    /* Theme-aware Text Colors */
    body:not(.dark-mode) .text-slate-400 { color: #64748b !important; }
    body:not(.dark-mode) .text-slate-300 { color: #334155 !important; }
    body:not(.dark-mode) .text-slate-500 { color: #64748b !important; }

    /* Glow Effects */
    .glow-blue { 
        position: absolute; top: -20%; right: -10%; width: 200px; height: 200px; 
        background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%); 
        filter: blur(40px); 
        opacity: 0.6;
    }
    
    @media (max-width: 1024px) {
        .bento-grid { grid-template-columns: repeat(2, 1fr); }
        .card-hero { grid-column: span 2; }
    }
    @media (max-width: 640px) {
        .bento-grid { grid-template-columns: 1fr; }
        .card-hero, .card-span-2 { grid-column: span 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen pt-12">
    <div class="bento-grid">
        <!-- 1. Hero Welcome Card -->
        <div class="bento-card card-hero">
            <div class="flex flex-col justify-center">
                <div class="ai-insight-badge mb-4 w-fit">FORKAST AI ANALYTICS ENGINE</div>
                <h1 class="text-4xl lg:text-5xl font-black mb-4">
                    ë°˜ê°‘ìŠµë‹ˆë‹¤, <span class="bg-gradient-to-r from-blue-500 to-emerald-500 bg-clip-text text-transparent">{{ user.get_short_name|default:user.username }}</span> ì‚¬ì¥ë‹˜
                </h1>
                <p class="text-slate-400 text-lg font-medium">ë°ì´í„° ë¶„ì„ì„ í†µí•´ ë§¤ì¥ì˜ ìˆ¨ê²¨ì§„ ì ì¬ë ¥ì„ ë°œê²¬í•˜ì„¸ìš”.</p>
            </div>
            <div class="hidden lg:block">
                <div class="w-48 h-48 rounded-full bg-blue-500/10 flex items-center justify-center border border-blue-500/20 relative">
                    <div class="absolute inset-0 border-2 border-dashed border-blue-500/20 rounded-full animate-spin-slow"></div>
                    <i class="fa-solid fa-robot text-6xl text-blue-500/50"></i>
                </div>
            </div>
        </div>

        <!-- 2. Main KPI: Today Revenue -->
        <div class="bento-card card-span-2">
            <div class="glow-blue"></div>
            <div class="kpi-title">ì˜¤ëŠ˜ì˜ ì‹¤ì‹œê°„ ë§¤ì¶œ</div>
            <div class="kpi-value">â‚©{{ current_revenue|intcomma }}</div>
            <div class="kpi-delta {% if revenue_delta >= 0 %}delta-up{% else %}delta-down{% endif %}">
                <i class="fa-solid {% if revenue_delta >= 0 %}fa-caret-up{% else %}fa-caret-down{% endif %}"></i>
                ì§€ë‚œì£¼ ëŒ€ë¹„ {{ abs_revenue_delta|intcomma }}ì› ({{ revenue_percent }}%)
            </div>
            <div class="mt-8 h-48 w-full" id="realtimeSalesChart"></div>
        </div>

        <!-- 3. AI Performance Analysis -->
        <div class="bento-card card-row-2">
            <div class="flex items-center justify-between mb-6">
                <span class="text-lg font-black">AI ì„±ê³¼ ë¶„ì„</span>
                <div class="w-10 h-10 bg-blue-500/10 rounded-xl flex items-center justify-center text-blue-500">
                    <i class="fa-solid fa-bolt"></i>
                </div>
            </div>
            <div class="text-center mb-10">
                <div class="relative inline-flex items-center justify-center w-32 h-32 mb-4">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="64" cy="64" r="56" fill="transparent" stroke="rgba(255,255,255,0.05)" stroke-width="12"></circle>
                        <circle cx="64" cy="64" r="56" fill="transparent" stroke="var(--accent-blue)" stroke-width="12" stroke-dasharray="351.858" stroke-dashoffset="{{ performance_offset }}" stroke-linecap="round"></circle>
                    </svg>
                    <div class="absolute text-2xl font-black">{{ performance_ratio }}%</div>
                </div>
                <div class="text-xl font-bold {% if performance_status == 'PROFIT' %}text-emerald-400{% else %}text-red-400{% endif %}">
                    {% if performance_status == 'PROFIT' %}í‘ì ìœ ì§€ ì¤‘{% else %}ì ì ì£¼ì˜ ë‹¨ê³„{% endif %}
                </div>
            </div>
            <div class="space-y-4">
                <div class="p-4 bg-slate-100/50 dark:bg-white/5 rounded-2xl border border-slate-200 dark:border-white/5">
                    <div class="text-xs font-bold text-slate-500 mb-1">ì˜¤ëŠ˜ ëª©í‘œ ë§¤ì¶œ</div>
                    <div class="text-lg font-black kpi-value" style="font-size: 1.25rem;">â‚©{{ target_revenue|intcomma }}</div>
                </div>
                <div class="p-4 bg-slate-100/50 dark:bg-white/5 rounded-2xl border border-slate-200 dark:border-white/5">
                    <div class="text-xs font-bold text-slate-500 mb-1">AI ì˜ˆì¸¡ ì”ì—¬ ë§¤ì¶œ</div>
                    <div class="text-lg font-black text-blue-500" id="ai-rem-revenue">ë¶„ì„ ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- 4. AI Consultant Insight -->
        <div class="bento-card card-span-2 card-row-2">
            <div class="flex items-center gap-3 mb-6">
                <div class="ai-insight-badge">REAL-TIME INSIGHT</div>
                <span class="text-slate-500 font-bold text-sm">AI ì¸í…”ë¦¬ì „ìŠ¤ ë¦¬í¬íŠ¸</span>
            </div>
            <h3 class="text-2xl font-bold mb-6 italic" id="ai-insight-title">"{{ consultant.diagnosis }}"</h3>
            <div class="p-6 bg-blue-500/5 rounded-2xl border border-blue-500/10 mb-8">
                <p class="text-emerald-400 font-bold mb-2">{{ consultant.comparative_insight }}</p>
                <p class="text-slate-300 leading-relaxed font-medium">{{ consultant.reason }}</p>
            </div>
            <div class="space-y-4">
                <h4 class="text-sm font-black text-slate-500 uppercase tracking-widest">ì¶”ì²œ ëŒ€ì‘ ì „ëµ</h4>
                {% for imp in consultant.improvement %}
                <div class="strategy-item group cursor-pointer hover:shadow-md transition-all">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-blue-400 mb-1">{{ imp.title }}</div>
                            <div class="text-sm text-slate-400 group-hover:text-slate-300">{{ imp.desc }}</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-slate-600 group-hover:text-blue-400 text-xs mt-1"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 5. Inventory Status -->
        <div class="bento-card">
            <div class="kpi-title">ì¬ê³  í˜„í™©</div>
            <div class="flex items-center justify-between mt-2">
                <i class="fa-solid fa-boxes-stacked text-3xl text-emerald-400/50"></i>
                <div class="text-right">
                    <div class="text-2xl font-black">{{ inventory_ctx }}</div>
                    <span class="text-xs font-bold text-slate-500">ì‹¤ì‹œê°„ í™•ì¸ë¨</span>
                </div>
            </div>
        </div>

        <!-- 6. Weather & Event -->
        <div class="bento-card">
            <div class="kpi-title">ìš´ì˜ í™˜ê²½</div>
            <div class="flex items-center justify-between mt-2">
                <i class="fa-solid fa-cloud-sun text-3xl text-amber-400/50"></i>
                <div class="text-right">
                    <div class="text-2xl font-black">
                        {% if weather_obj %}{{ weather_obj.temperature }}Â°C, {{ weather_obj.condition }}{% else %}ì •ë³´ ì—†ìŒ{% endif %}
                    </div>
                    <span class="text-xs font-bold text-slate-500">ë§¤ì¥ ì¸ê·¼ ë‚ ì”¨</span>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Footer (Dashboard Only) -->
    <footer class="mt-20 border-t border-slate-200 dark:border-slate-700/50 bg-white/80 dark:bg-slate-900/50 backdrop-blur-sm py-12 px-6 lg:px-12">
        <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
            <!-- Brand -->
            <div class="md:col-span-2">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-indigo-600">Forkast AI</span>
                </div>
                <p class="text-slate-500 dark:text-gray-400 mb-4 max-w-sm">
                    AI ê¸°ë°˜ ë°ì¼ë¦¬ ë§¤ì¶œ ì˜ˆì¸¡ ë° ë§¤ì¥ ê´€ë¦¬ ì†”ë£¨ì…˜.<br>
                    ë°ì´í„°ë¡œ ì¦ëª…í•˜ëŠ” ì„±ê³µ, í¬ì¹´ìŠ¤íŠ¸ì™€ í•¨ê»˜í•˜ì„¸ìš”.
                </p>
                <div class="flex gap-4">
                    <a href="#" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 dark:text-gray-400 hover:bg-blue-600 hover:text-white transition">ğŸ¦</a>
                    <a href="#" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 dark:text-gray-400 hover:bg-blue-600 hover:text-white transition">ğŸ“˜</a>
                    <a href="#" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 dark:text-gray-400 hover:bg-blue-600 hover:text-white transition">ğŸ“¸</a>
                </div>
            </div>

            <!-- Links 1 -->
            <div>
                <h4 class="font-bold text-slate-900 dark:text-white mb-4">ì„œë¹„ìŠ¤</h4>
                <ul class="space-y-2 text-slate-500 dark:text-gray-400">
                    <li><a href="{% url 'sales_dashboard' %}" class="hover:text-blue-500 transition">ë§¤ì¶œ ë¶„ì„</a></li>
                    <li><a href="{% url 'analytics_forecast' %}" class="hover:text-blue-500 transition">AI ì˜ˆì¸¡</a></li>
                    <li><a href="{% url 'analytics_menu' %}" class="hover:text-blue-500 transition">ë©”ë‰´ ì¸ì‚¬ì´íŠ¸</a></li>
                    <li><a href="{% url 'settings' %}" class="hover:text-blue-500 transition">ìš”ê¸ˆì œ ì•ˆë‚´</a></li>
                </ul>
            </div>

            <!-- Links 2 -->
            <div>
                <h4 class="font-bold text-slate-900 dark:text-white mb-4">ê³ ê° ì§€ì›</h4>
                <ul class="space-y-2 text-slate-500 dark:text-gray-400">
                    <li><a href="#" class="hover:text-blue-500 transition">ê³µì§€ì‚¬í•­</a></li>
                    <li><a href="#" class="hover:text-blue-500 transition">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</a></li>
                    <li><a href="#" class="hover:text-blue-500 transition">1:1 ë¬¸ì˜í•˜ê¸°</a></li>
                    <li><a href="#" class="hover:text-blue-500 transition">API ë¬¸ì„œ</a></li>
                </ul>
            </div>
        </div>

        <div class="max-w-7xl mx-auto border-t border-slate-200 dark:border-slate-800 pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-slate-400 dark:text-gray-300">
            <div class="text-center md:text-left">
                <p class="mb-2">
                    (ì£¼)í¬ì¹´ìŠ¤íŠ¸ | ëŒ€í‘œì´ì‚¬: ê¹€í™˜í¬ | ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 123-45-67890<br>
                    ì£¼ì†Œ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 427 ìœ„ì›Œí¬íƒ€ì›Œ 3ì¸µ | í†µì‹ íŒë§¤ì—…ì‹ ê³ : 2026-ì„œìš¸ê°•ë‚¨-00123
                </p>
                <p>Copyright Â© 2026 Forkast Corp. All rights reserved.</p>
            </div>
            <div class="flex gap-6">
                <a href="#" class="hover:text-blue-500 dark:hover:text-white transition">ì´ìš©ì•½ê´€</a>
                <a href="#" class="hover:text-blue-500 dark:hover:text-white transition font-bold">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
                <a href="#" class="hover:text-blue-500 dark:hover:text-white transition">ìš´ì˜ì •ì±…</a>
            </div>
        </div>
    </footer>

    <!-- Modals -->
    <!-- Strategy Modals (Hardcoded for zero-JS functionality) -->
    <div id="modal-container">
        <!-- Modal 0 -->
        <div id="modal-0" class="fixed inset-0 z-[100] hidden items-center justify-center">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeStrategyModal('modal-0')"></div>
            <div class="relative bg-white border border-slate-200 p-10 rounded-3xl max-w-2xl w-full mx-4 shadow-2xl modal-content animate-in zoom-in duration-300">
                <button onclick="closeStrategyModal('modal-0')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button>
                <div class="h-20 w-20 bg-blue-50 rounded-2xl mb-8 flex items-center justify-center text-5xl">ğŸš€</div>
                <h3 class="text-3xl font-black mb-6" style="color: #0f172a !important;">ê¸´ê¸‰ íƒ€ì„ ì„¸ì¼</h3>
                <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 mb-8">
                    <p class="leading-relaxed font-bold text-lg" style="color: #334155 !important;">ìœ ë™ ì¸êµ¬ê°€ ë§ì€ ì˜¤í›„ 2ì‹œ~4ì‹œ ì‹œê°„ëŒ€ì— í• ì¸ì„ ì ìš©í•˜ì—¬ ë°©ë¬¸ìœ¨ê³¼ ê°ë‹¨ê°€ë¥¼ ë™ì‹œì— ê·¹ëŒ€í™”í•˜ì„¸ìš”.</p>
                </div>
                <button onclick="closeStrategyModal('modal-0')" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 transition shadow-lg">í™•ì¸</button>
            </div>
        </div>
        <!-- Modal 1 -->
        <div id="modal-1" class="fixed inset-0 z-[100] hidden items-center justify-center">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeStrategyModal('modal-1')"></div>
            <div class="relative bg-white border border-slate-200 p-10 rounded-3xl max-w-2xl w-full mx-4 shadow-2xl modal-content animate-in zoom-in duration-300">
                <button onclick="closeStrategyModal('modal-1')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button>
                <div class="h-20 w-20 bg-indigo-50 rounded-2xl mb-8 flex items-center justify-center text-5xl">ğŸ“¦</div>
                <h3 class="text-3xl font-black mb-6" style="color: #0f172a !important;">ì¬ê³  ìµœì í™”</h3>
                <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 mb-8">
                    <p class="leading-relaxed font-bold text-lg" style="color: #334155 !important;">ì£¼ë§ ëŒ€ë¹„ ìˆ˜ìš”ê°€ ë†’ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ëŠ” ì£¼ìš” ì›ì¬ë£Œì™€ ì¸ê¸° í’ˆëª©ì˜ ì¬ê³ ë¥¼ ì„ ì œì ìœ¼ë¡œ í™•ë³´í•˜ì„¸ìš”.</p>
                </div>
                <button onclick="closeStrategyModal('modal-1')" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 transition shadow-lg">í™•ì¸</button>
            </div>
        </div>
        <!-- Modal 2 -->
        <div id="modal-2" class="fixed inset-0 z-[100] hidden items-center justify-center">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeStrategyModal('modal-2')"></div>
            <div class="relative bg-white border border-slate-200 p-10 rounded-3xl max-w-2xl w-full mx-4 shadow-2xl modal-content animate-in zoom-in duration-300">
                <button onclick="closeStrategyModal('modal-2')" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button>
                <div class="h-20 w-20 bg-emerald-50 rounded-2xl mb-8 flex items-center justify-center text-5xl">ğŸ‘¥</div>
                <h3 class="text-3xl font-black mb-6" style="color: #0f172a !important;">ì¸ë ¥ íš¨ìœ¨í™”</h3>
                <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100 mb-8">
                    <p class="leading-relaxed font-bold text-lg" style="color: #334155 !important;">ë§¤ì¶œ ì§‘ì¤‘ ì‹œê°„ëŒ€ì— ìˆ™ë ¨ëœ ì¸ë ¥ì„ ì¬ë°°ì¹˜í•˜ì—¬ ì„œë¹„ìŠ¤ ì†ë„ì™€ ë§Œì¡±ë„ë¥¼ ìµœìƒìœ¼ë¡œ ìœ ì§€í•˜ì„¸ìš”.</p>
                </div>
                <button onclick="closeStrategyModal('modal-2')" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 transition shadow-lg">í™•ì¸</button>
            </div>
        </div>
    </div>
    <div id="applied-modal" class="fixed inset-0 z-[200] hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeAppliedModal()"></div>
        <div class="relative glass bg-gray-900 border border-gray-700 p-8 rounded-2xl max-w-2xl w-full mx-4 shadow-2xl transform transition-all scale-95 opacity-0 modal-content">
            <button onclick="closeAppliedModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-3"><span>ğŸ“‹</span> í˜„ì¬ ì ìš©ëœ ì „ëµ ëª©ë¡</h3>
            <div class="bg-gray-800/50 rounded-xl p-6 min-h-[200px] max-h-[400px] overflow-y-auto custom-scrollbar">
                <ul id="applied-list" class="space-y-4"><li class="text-gray-300 text-center py-8">ì•„ì§ ì ìš©ëœ ì „ëµì´ ì—†ìŠµë‹ˆë‹¤.</li></ul>
            </div>
            <div class="flex justify-end mt-6 gap-3">
                <button onclick="undoLastStrategy()" class="px-6 py-3 bg-red-600/80 hover:bg-red-500 rounded-lg text-white font-bold transition flex items-center gap-2"><span>â†©ï¸</span> ì‹¤í–‰ ì·¨ì†Œ</button>
                <button onclick="closeAppliedModal()" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-bold transition">í™•ì¸</button>
            </div>
        </div>
    </div>
    
    <div id="decision-modal" class="fixed inset-0 z-[200] hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeDecisionModal()"></div>
        <div class="relative glass bg-gray-900 border border-gray-700 p-8 md:p-12 rounded-2xl max-w-2xl w-full mx-4 shadow-2xl transform transition-all scale-95 opacity-0 modal-content">
            <button onclick="closeDecisionModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <div class="flex items-center gap-4 mb-6">
                <span id="dm-icon" class="text-6xl"></span>
                <div><span id="dm-category" class="text-blue-400 font-bold uppercase tracking-wider text-sm"></span><h3 id="dm-title" class="text-3xl font-bold mt-1"></h3></div>
            </div>
            <div id="dm-content" class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50 mb-8 text-gray-300 text-lg leading-relaxed whitespace-pre-line"></div>
            <div class="flex justify-end gap-4">
                <button onclick="closeDecisionModal()" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-bold transition">ë‹«ê¸°</button>
                <button id="btn-apply-decision" onclick="applyDecisionStrategy()" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-bold transition flex items-center gap-2"><span>ğŸš€</span> ì „ëµ ì ìš©í•˜ê¸°</button>
            </div>
        </div>
    </div>
    
    <div id="video-modal" class="fixed inset-0 z-[300] hidden items-center justify-center bg-black/90">
         <div class="absolute inset-0" onclick="closeVideoModal()"></div>
         <div class="relative w-full max-w-5xl aspect-video bg-black rounded-xl overflow-hidden shadow-2xl">
             <button onclick="closeVideoModal()" class="absolute top-4 right-4 text-white text-3xl z-50 hover:text-red-500 transition">&times;</button>
             <video id="modal-video-player" class="w-full h-full" controls>
                 <source src="" type="video/mp4">
             </video>
         </div>
    </div>

    <!-- Analysis Result Modal (New) -->
    <div id="analysis-modal" class="fixed inset-0 z-[300] hidden items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeAnalysisModal()"></div>
        <div class="relative bg-white border border-slate-200 p-8 rounded-3xl max-w-xl w-full mx-4 shadow-2xl modal-content animate-in zoom-in duration-300">
            <button onclick="closeAnalysisModal()" class="absolute top-5 right-5 text-slate-400 hover:text-red-500 text-2xl font-bold transition">&times;</button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h3 id="am-title" class="text-2xl font-black text-slate-800">ë¶„ì„ ì™„ë£Œ</h3>
            </div>
            <div class="bg-slate-50 rounded-xl p-6 border border-slate-100 max-h-[60vh] overflow-y-auto mb-6">
                <p id="am-content" class="text-slate-600 font-medium leading-relaxed whitespace-pre-line text-lg"></p>
            </div>
            <button onclick="closeAnalysisModal()" class="w-full py-3.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-500 transition shadow-lg shadow-blue-500/30">
                í™•ì¸
            </button>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Dashboard
    document.addEventListener('DOMContentLoaded', () => {
        // AI ì˜ˆì¸¡ ì”ì—¬ ë§¤ì¶œ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        setTimeout(() => {
            const remRevenue = document.getElementById('ai-rem-revenue');
            if(remRevenue) remRevenue.innerText = 'â‚© 420,000';
        }, 1500);

        // ê¸°ë³¸ ë°ì´í„° ë¡œë“œ (API ì—°ë™ ì‹œ ì‚¬ìš©)
        loadDashboardData();
    });

    function loadDashboardData() {
        fetch("{% url 'dashboard_stats_api' %}")
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') {
                    // 1. ì‹¤ì‹œê°„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                    if (d.hourly_sales) {
                        updateRealtimeChart(d.hourly_sales);
                    }
                }
            })
            .catch(err => {
                console.error("Dashboard data load failed:", err);
                // ëª¨ì˜ ë°ì´í„°ë¡œ ì°¨íŠ¸ í‘œì‹œ (ì˜¤í”„ë¼ì¸/ì—ëŸ¬ ëŒ€ë¹„)
                updateRealtimeChart([50000, 45000, 30000, 20000, 15000, 10000, 12000, 25000, 45000, 70000, 85000, 90000, 110000, 105000, 95000, 100000, 120000, 130000, 115000, 90000, 75000, 60000, 55000, 52000]);
            });
    }

    function updateRealtimeChart(data) {
        // Highcharts AreaSpline
        const kpiLabelColor = getComputedStyle(document.documentElement).getPropertyValue('--kpi-label').trim();
        const glassBorder = getComputedStyle(document.documentElement).getPropertyValue('--glass-border').trim();
        const accentBlue = getComputedStyle(document.documentElement).getPropertyValue('--accent-blue').trim();

        Highcharts.chart('realtimeSalesChart', {
            chart: {
                type: 'areaspline',
                backgroundColor: 'transparent',
                style: { fontFamily: "'Inter', sans-serif" },
                margin: [10, 0, 30, 0]
            },
            title: { text: null },
            credits: { enabled: false },
            xAxis: {
                categories: [...Array(24).keys()].map(h => h.toString().padStart(2, '0') + ':00'),
                gridLineWidth: 0,
                lineWidth: 0,
                labels: { style: { color: kpiLabelColor, fontSize: '10px' }, step: 4 }
            },
            yAxis: {
                title: { text: null },
                gridLineColor: glassBorder,
                labels: { enabled: false }
            },
            tooltip: {
                shared: true,
                backgroundColor: 'rgba(15, 23, 42, 0.9)', // Tooltipì€ í•­ìƒ ì–´ë‘¡ê²Œ ìœ ì§€ (ê°€ë…ì„±)
                borderColor: accentBlue,
                borderRadius: 12,
                style: { color: '#f8fafc' },
                valueSuffix: 'ì›'
            },
            plotOptions: {
                areaspline: {
                    fillOpacity: 0.1,
                    marker: { enabled: false },
                    lineWidth: 3
                }
            },
            series: [{
                name: 'ì˜¤ëŠ˜ ë§¤ì¶œ',
                data: data,
                color: accentBlue,
                fillColor: {
                    linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                    stops: [[0, 'rgba(59, 130, 246, 0.3)'], [1, 'rgba(59, 130, 246, 0)']]
                }
            }]
        });
    }

    // Modal & Strategy (Simplified for Bento)
    function openStrategyModal(mid) { 
        const modal = document.getElementById(mid);
        if(modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }
    function closeStrategyModal(mid) {
        const modal = document.getElementById(mid);
        if(modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

</script>
{% endblock %}
