{% load static humanize %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forkast - AI Daily Sales Prediction & Care</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            scroll-behavior: smooth;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hero-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }

        .section {
            min-height: 100vh;
            padding: 4rem 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .fade-in {
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Healing Overlay Animations */
        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Fireworks CSS */
        .firework-spark {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
            /* Ensure on top */
        }

        /* Gradient Animation remains for background */
        .healing-gradient {
            background: radial-gradient(circle at center, #1e1b4b 0%, #000000 100%);
            background-size: 200% 200%;
            animation: gradientBG 20s ease infinite;
        }

        .particle {
            position: absolute;
            bottom: -50px;
            background: radial-gradient(circle, #ffffff 10%, #ffd700 40%, #ff8c00 90%, transparent 100%);
            box-shadow: 0 0 10px 2px rgba(255, 215, 0, 0.4);
            border-radius: 50%;
            opacity: 0;
            /* Animation handled by JS now */
            filter: blur(1px);
            z-index: 1;
        }
    </style>
</head>

<body class="bg-gray-900 text-white">
    <!-- FORKAST_FIX_V2_ROBUST_SYNTAX -->

    <!-- 1. Navigation -->
    <!-- 1. Sidebar Navigation (Desktop) -->
    <aside class="fixed inset-y-0 left-0 w-64 glass bg-gray-900/90 border-r border-gray-700 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out" id="sidebar">
        <div class="p-6 flex items-center justify-between">
            <a href="/admin/" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 hover:opacity-80 transition cursor-pointer">
                Forkast AI
            </a>
            <button class="lg:hidden text-gray-400 hover:text-white" onclick="toggleSidebar()">
                âœ•
            </button>
        </div>

        <nav class="px-4 space-y-2 mt-4 overflow-y-auto h-[calc(100%-8rem)]">
            <!-- 1. Dashboard -->
            <a href="javascript:void(0)" onclick="showPage('section-dashboard')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-600/20 text-blue-400 font-bold border border-blue-500/30 transition hover:scale-105 active:scale-95" data-target="section-dashboard">
                <span>ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ
            </a>

            <!-- 2. Analytics -->
            <div class="pt-4 pb-2 text-xs font-black text-gray-200 uppercase tracking-widest px-4">ë§¤ì¶œ ë¶„ì„</div>
            <a href="javascript:void(0)" onclick="showPage('analytics-sales')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-gray-200 hover:text-white transition cursor-pointer" data-target="analytics-sales">
                <span>ğŸ“ˆ</span> ìƒì„¸ ë§¤ì¶œ ë¶„ì„
            </a>
            <a href="javascript:void(0)" onclick="showPage('analytics-forecast')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-gray-200 hover:text-white transition cursor-pointer" data-target="analytics-forecast">
                <span>ğŸ¤–</span> AI ë§¤ì¶œ ì˜ˆì¸¡
            </a>
            <a href="javascript:void(0)" onclick="showPage('analytics-menu')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-gray-200 hover:text-white transition cursor-pointer" data-target="analytics-menu">
                <span>ğŸ½</span> ë©”ë‰´ ì„±ê³¼
            </a>
            <a href="javascript:void(0)" onclick="showPage('analytics-time')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-gray-200 hover:text-white transition cursor-pointer" data-target="analytics-time">
                <span>â°</span> ì‹œê°„/ìš”ì¼ ì¸ì‚¬ì´íŠ¸
            </a>
            <a href="javascript:void(0)" onclick="showPage('analytics-delivery')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-gray-200 hover:text-white transition cursor-pointer" data-target="analytics-delivery">
                <span>ğŸšš</span> ë°°ë‹¬ ë¶„ì„
            </a>

            <!-- 3. Management -->
            <div class="pt-4 pb-2 text-xs font-black text-gray-200 uppercase tracking-widest px-4">ìš´ì˜ ê´€ë¦¬</div>
             <a href="javascript:void(0)" onclick="showPage('notifications')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-gray-300 hover:text-white transition cursor-pointer" data-target="notifications">
                <span>ğŸš¨</span> ì•Œë¦¼ ì„¼í„°
                <span class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">3</span>
            </a>
            <a href="javascript:void(0)" onclick="showPage('settings')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-gray-300 hover:text-white transition cursor-pointer" data-target="settings">
                <span>âš™ï¸</span> ì„¤ì •
            </a>
        </nav>

        <div class="absolute bottom-0 w-full p-4 border-t border-gray-700 bg-gray-900/50 backdrop-blur-md space-y-2">
            <a href="{% url 'admin:index' %}" class="flex items-center justify-center gap-2 w-full bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 border border-blue-500/30 px-4 py-2.5 rounded-xl font-bold text-sm transition">
                <span>ğŸª</span> ê°€ë§¹ì  ê´€ë¦¬
            </a>
            <a href="{% url 'super_admin' %}" class="flex items-center justify-center gap-2 w-full bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 border border-purple-500/30 px-4 py-2.5 rounded-xl font-bold text-sm transition">
                <span>ğŸ¢</span> ë³¸ì‚¬ ê´€ë¦¬
            </a>
            <a href="{% url 'toggle_work' %}" class="flex items-center justify-center gap-2 w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/50 px-4 py-3 rounded-xl font-bold transition">
                <span>ğŸ›‘</span> ì—…ë¬´ ì¢…ë£Œ
            </a>
        </div>
    </aside>

    <!-- Mobile Header -->
    <div class="lg:hidden fixed top-0 w-full z-40 glass px-6 py-4 flex justify-between items-center bg-gray-900/90 backdrop-blur-md">
        <div class="text-xl font-bold text-blue-400">Forkast AI</div>
        <button class="text-white text-2xl" onclick="toggleSidebar()">
            â˜°
        </button>
    </div>

    <!-- Main Content Wrapper -->
    <main class="lg:ml-64 flex flex-col min-h-screen relative z-0 transition-all duration-300">


    <!-- 2. Hero Section -->
    <section class="section relative overflow-hidden flex items-end pb-20">
        <!-- Main Video -->
        <video class="hero-video" autoplay muted loop playsinline>
            <source src="{% static 'videos/hero.mp4' %}" type="video/mp4">
            <!-- Fallback for no video -->
            <div class="bg-gray-900 w-full h-full"></div>
        </video>
        <!-- Cinematic Gradient Overlay -->
        <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/60 to-transparent z-0"></div>

        <div class="relative z-10 max-w-7xl mx-auto w-full px-6 flex flex-col lg:flex-row items-end gap-12 fade-in">

            <!-- Left: Main Title -->
            <div class="flex-1 text-left lg:mb-4">
                <span
                    class="inline-block py-1 px-3 rounded-full bg-blue-500/20 text-blue-400 text-sm font-bold mb-4 border border-blue-500/30">Forkast
                    AI Solution</span>
                <h1 class="text-5xl lg:text-7xl font-bold mb-6 leading-tight text-white drop-shadow-lg">
                    AI ê¸°ë°˜<br>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400">ë°ì¼ë¦¬ ë§¤ì¶œ
                        ì˜ˆì¸¡</span>
                </h1>
                <p class="text-lg text-gray-300 max-w-lg leading-relaxed drop-shadow-md">
                    ë‹¹ì‹ ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ì„í•˜ì—¬,<br>
                    ì˜¤ëŠ˜ì˜ ì„±ê³µ ì „ëµê³¼ ë”°ëœ»í•œ ê°ì„± ì¼€ì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
                </p>
            </div>

            <!-- Right: Real-time Data Cards (Compact) -->
            <div class="w-full lg:w-auto flex-none">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Card 1: Revenue -->
                    <a href="{% url 'sales_dashboard' %}"
                        class="block glass p-5 rounded-xl border-l-4 border-blue-500 hover:bg-white/5 transition cursor-pointer relative z-[100] hover:scale-105">
                        <h3 class="text-gray-200 text-xs uppercase font-black tracking-widest mb-1">ì˜¤ëŠ˜ ì˜ˆìƒ ë§¤ì¶œ (AI)</h3>
                        <p id="prediction-value" class="text-2xl font-bold text-white">
                            {% if prediction_display %}
                            â‚© {{ prediction_display|intcomma }}
                            {% else %}
                            <span class="animate-pulse">ë¶„ì„ì¤‘...</span>
                            {% endif %}
                        </p>
                        <div id="prediction-status" class="mt-2 text-xs text-blue-200 flex items-center gap-1 font-bold">
                            <span>ğŸ“ˆ</span> <span>ì‹¤ì‹œê°„ ë¶„ì„ ì¤‘</span>
                        </div>
                    </a>

                    <!-- Card 2: Weather -->
                    <div class="glass p-5 rounded-xl border-l-4 border-yellow-500">
                        <h3 class="text-gray-200 text-xs uppercase font-black tracking-widest mb-1">í˜„ì¬ ë‚ ì”¨ ì„íŒ©íŠ¸</h3>
                        <p id="weather-cond" class="text-2xl font-bold text-white">
                            {% if weather_obj %}
                            {{ weather_obj.condition }}
                            {% else %}
                            <span class="animate-pulse">--</span>
                            {% endif %}
                        </p>
                        <div class="mt-2 text-xs text-yellow-200 flex items-center gap-1 font-bold">
                            <span>ğŸŒ¡ï¸</span>
                            <span id="weather-temp">
                                {% if weather_obj %}
                                {{ weather_obj.temperature }}Â°
                                {% else %}
                                --
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <!-- Card 3: Inventory -->
                    <a href="{% url 'inventory' %}"
                        class="block glass p-5 rounded-xl border-l-4 border-green-500 hover:bg-white/5 transition cursor-pointer relative z-10">
                        <h3 class="text-gray-200 text-xs uppercase font-black tracking-widest mb-1">ì¬ê³  ìƒíƒœ</h3>
                        <p class="text-2xl font-bold text-white">
                            {% if "ë¶€ì¡±" in inventory_ctx %}
                            ì£¼ì˜
                            {% else %}
                            ì•ˆì •ì 
                            {% endif %}
                        </p>
                        <div class="mt-2 text-xs text-green-300 truncate max-w-[140px]" title="{{ inventory_ctx }}">
                            {{ inventory_ctx|default:"ë°ì´í„° ì—†ìŒ" }}
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- 3. Service Explanation Video -->
    <section class="section bg-gray-800">
        <div class="max-w-7xl mx-auto w-full flex flex-col md:flex-row items-center gap-16 px-6">
            <div class="w-full md:w-1/2">
                <div data-src="{% static 'videos/service.mp4' %}" onclick="openVideoModal(this.dataset.src)"
                    class="aspect-video bg-gray-700 rounded-xl overflow-hidden shadow-2xl flex items-center justify-center relative group cursor-pointer hover:ring-4 ring-blue-500/50 transition">
                    <video class="w-full h-full object-cover pointer-events-none">
                        <!-- pointer-events-none prevent default controls from catching click -->
                        <source src="{% static 'videos/service.mp4' %}" type="video/mp4">
                    </video>
                    <!-- Play Overlay -->
                    <div
                        class="absolute inset-0 bg-black/40 group-hover:bg-black/20 flex items-center justify-center transition">
                        <div
                            class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center group-hover:scale-110 transition border border-white/30">
                            <span class="text-4xl text-white ml-2">â–¶</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/2 text-left">
                <h2 class="text-4xl lg:text-5xl font-bold mb-8 leading-tight">AIê°€ ë¶„ì„í•˜ëŠ”<br>ì´ˆê°œì¸í™” ë¹„ì¦ˆë‹ˆìŠ¤ ì „ëµ</h2>
                <p class="text-lg lg:text-xl text-gray-300 leading-relaxed">Forkastì˜ AIëŠ” ë‹¨ìˆœí•œ í†µê³„ê°€ ì•„ë‹™ë‹ˆë‹¤. ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€í™”í•˜ëŠ” ì‹œì¥ ìƒí™©ì„
                    ì½ê³ , ë‹¹ì‹ ì˜ ë§¤ì¥ì— ë”± ë§ëŠ” ì „ëµì„
                    ì œì‹œí•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </section>

    <!-- 4. Promo Video -->
    <section class="section bg-gray-900">
        <div class="max-w-7xl mx-auto w-full text-center px-6">
            <h2 class="text-4xl font-bold mb-12">ì„±ê³µí•˜ëŠ” ì‚¬ì¥ë‹˜ë“¤ì˜ ë¹„ë°€</h2>
            <div data-src="{% static 'videos/promo.mp4' %}" onclick="openVideoModal(this.dataset.src)"
                class="aspect-video bg-gray-800 rounded-xl overflow-hidden shadow-2xl mx-auto max-w-5xl flex items-center justify-center relative cursor-pointer group hover:ring-4 ring-blue-500/50 transition">
                <video class="w-full h-full object-cover pointer-events-none">
                    <source src="{% static 'videos/promo.mp4' %}" type="video/mp4">
                </video>
                <!-- Play Overlay -->
                <div
                    class="absolute inset-0 bg-black/40 group-hover:bg-black/20 flex items-center justify-center transition">
                    <div
                        class="w-24 h-24 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center group-hover:scale-110 transition border border-white/30">
                        <span class="text-5xl text-white ml-2">â–¶</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 5. AI Sales Analysis -->
    <section class="section bg-gray-800">
        <div class="max-w-7xl mx-auto w-full px-6">
            <h2 class="text-4xl font-bold mb-12 text-center">ì‹¤ì‹œê°„ ë§¤ì¶œ ë¶„ì„ ë° íë¦„ ì˜ˆì¸¡</h2>
            <!-- Row 1: Real-time Analysis (Existing) -->
            <!-- Row 1: Real-time Analysis (Redesigned) -->
            <div class="mb-8 flex justify-between items-end border-b border-gray-700 pb-4">
                <div>
                    <h3 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-300">
                        ì˜¤ëŠ˜ ì‹¤ì‹œê°„ ë¶„ì„
                    </h3>
                    <p class="text-gray-400 mt-1 text-sm">ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ AI ë§¤ì¶œ í†µì°°ë ¥</p>
                </div>
                <div class="flex items-center gap-3">
                    <input type="file" id="csvUploadInput" accept=".csv" class="hidden" onchange="uploadCSV(this)">
                    <button onclick="document.getElementById('csvUploadInput').click()" 
                        class="group relative px-6 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 transition-all shadow-lg hover:shadow-blue-500/30 overflow-hidden">
                        <div class="absolute inset-0 bg-white/20 group-hover:translate-x-full transition-transform duration-500 ease-out -translate-x-full skew-x-12"></div>
                        <span class="relative font-bold text-white flex items-center gap-2">
                            <span>ğŸ“‚</span> ë°ì´í„° ì—…ë¡œë“œ
                        </span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
                <!-- Chart Column -->
                <div class="flex flex-col gap-8">
                    <!-- Real-time Chart Area -->
                    <div class="glass p-1 rounded-2xl bg-gradient-to-br from-white/10 to-transparent relative shadow-2xl">
                        <div class="bg-gray-900/80 backdrop-blur-xl rounded-xl p-6 h-96 flex flex-col relative text-center">
                            <div class="flex items-center justify-between mb-4 px-2">
                                <h3 class="text-sm font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full animate-ping"></span>
                                    ì‹¤ì‹œê°„ ë§¤ì¶œ íë¦„
                                </h3>
                                <span class="text-xs text-gray-500">24ì‹œê°„ ê¸°ì¤€</span>
                            </div>
                            <div id="salesChartContainer" class="w-full h-full">
                                <canvas id="salesChart"></canvas>
                            </div>
                            <div id="chart-overlay-msg" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity">
                                <span class="text-white/20 text-4xl font-bold">ë°ì´í„° ëŒ€ê¸° ì¤‘...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Trend Chart Area (NEW) -->
                    <div class="glass p-1 rounded-2xl bg-gradient-to-br from-white/10 to-transparent relative shadow-2xl overflow-hidden group">
                        <!-- Decorative Gradient -->
                        <div class="absolute -top-24 -right-24 w-48 h-48 bg-indigo-600/10 rounded-full blur-3xl group-hover:bg-indigo-600/20 transition-all duration-700"></div>
                        
                        <div class="bg-gray-900/80 backdrop-blur-xl rounded-xl p-6 h-[420px] flex flex-col relative text-center">
                            <div class="flex items-center justify-between mb-6 px-2">
                                <h3 class="text-sm font-bold text-indigo-400 uppercase tracking-widest flex items-center gap-2">
                                    <span>ğŸ—“ï¸</span>
                                    ì§€ë‚œ 7ì¼ ë§¤ì¶œ ì¶”ì´
                                </h3>
                                <span class="text-xs text-gray-500">ìµœê·¼ ì¼ì£¼ì¼ ë°ì´í„°</span>
                            </div>
                            <div id="weeklyTrendChart" class="w-full h-full"></div>
                            <!-- Loading State -->
                            <div id="weekly-chart-loading" class="absolute inset-0 flex items-center justify-center bg-gray-900/40 backdrop-blur-sm z-10 transition-opacity duration-500">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="w-10 h-10 border-4 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin"></div>
                                    <span class="text-xs text-indigo-300 font-bold tracking-widest">ë°ì´í„° ë™ê¸°í™” ì¤‘...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Dashboard -->
                <div class="flex flex-col gap-6">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass bg-gray-800/50 p-5 rounded-2xl border border-white/5 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-3 opacity-20 group-hover:scale-110 transition-transform text-4xl">ğŸ’°</div>
                            <h4 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">ì´ ë§¤ì¶œ (í•©ê³„)</h4>
                            <p class="text-3xl font-black text-white" id="stat-total-revenue">-</p>
                        </div>
                        <div class="glass bg-gray-800/50 p-5 rounded-2xl border border-white/5 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-3 opacity-20 group-hover:scale-110 transition-transform text-4xl">â±ï¸</div>
                            <h4 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">ì´ ì£¼ë¬¸ (ê±´ìˆ˜)</h4>
                            <p class="text-3xl font-black text-white" id="stat-total-orders">-</p>
                        </div>
                    </div>

                    <!-- AI Analysis Card -->
                    <div class="glass p-6 rounded-2xl border border-blue-500/30 bg-gradient-to-b from-blue-900/20 to-gray-900/50 relative shadow-lg">
                        <h3 class="flex items-center gap-2 font-bold text-xl text-blue-300 mb-4">
                            <span class="animate-pulse">ğŸ¤–</span> AI ë¶„ì„ ë¦¬í¬íŠ¸
                        </h3>
                        <p id="ai-analysis-text" class="text-gray-300 leading-relaxed text-base font-light">
                            {% if ai_sales_analysis %}
                            {{ ai_sales_analysis|linebreaksbr }}
                            {% else %}
                            <span class="text-gray-500 italic">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ AIê°€ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...</span>
                            {% endif %}
                        </p>
                    </div>

                    <!-- Healing Message (Premium Gold Style) -->
                    <div class="relative group">
                        <div class="absolute -inset-1 bg-gradient-to-r from-amber-400 to-orange-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                        <div class="relative bg-gray-900/80 backdrop-blur-xl p-6 rounded-2xl border border-amber-500/30 flex items-start gap-5">
                            <div class="bg-amber-500/20 p-3 rounded-full shrink-0">
                                <span class="text-3xl">ğŸ’Œ</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-xs font-bold text-amber-400 uppercase mb-2 tracking-widest flex items-center gap-2">
                                    ì˜¤ëŠ˜ì˜ íë§ ë©”ì‹œì§€
                                    <span class="h-px flex-1 bg-amber-500/30"></span>
                                </h4>
                                <p id="center-cheer-msg" class="text-amber-100/90 italic text-lg leading-relaxed font-serif">
                                    <span class="text-sm text-gray-400 not-italic font-sans">AIê°€ ë”°ëœ»í•œ ìœ„ë¡œë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Past Sales Analysis (New) -->
            <h3 class="text-2xl font-bold mb-6 text-left border-l-4 border-purple-500 pl-4 flex justify-between items-center">
                <span>ê³¼ê±° ë§¤ì¶œ ë° íë¦„ ë¶„ì„</span>
                <div class="flex items-center gap-2">
                    <input type="file" id="pastCsvUploadInput" accept=".csv" class="hidden" onchange="uploadPastCSV(this)">
                    <button onclick="document.getElementById('pastCsvUploadInput').click()" 
                        class="text-sm bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <span>ğŸ“‚</span> ê³¼ê±° ë°ì´í„° ì—…ë¡œë“œ
                    </button>
                </div>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <!-- Chart Placeholder -->
                <div class="glass p-8 rounded-xl h-96 flex items-center justify-center bg-gray-900/50 relative">
                    <div id="pastSalesChart" class="w-full h-full"></div>
                </div>
                <div class="space-y-6">
                    <div class="glass p-8 rounded-xl border-l-4 border-purple-500">
                        <h3 class="font-bold text-2xl mb-4">ğŸ“‰ AI ê³¼ê±° ë¶„ì„</h3>
                        <p id="past-analysis-text" class="text-gray-300 leading-relaxed text-lg">
                            <span class="animate-pulse">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 6. Decision Making Infographic -->
    <section class="section bg-gray-800">
        <h2 class="text-4xl font-bold mb-12 text-center">ì˜ì‚¬ê²°ì • ëŒ€ì‹œë³´ë“œ</h2>
        <div class="max-w-7xl mx-auto w-full glass p-12 rounded-2xl px-6">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8">
                <div>
                    <h3 class="text-2xl font-bold">ì˜¤ëŠ˜ì˜ AI ì¶”ì²œ ì•¡ì…˜</h3>
                    <p class="text-gray-400">ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ê°€ì¥ í™•ë¥  ë†’ì€ ì„±ê³µ ì „ëµì„ ì„ íƒí•˜ì„¸ìš”.</p>
                </div>
                <div class="text-right">
                    <span class="text-sm text-gray-400">ì‹ ë¢°ë„</span>
                    <div class="text-3xl font-bold text-green-400">92%</div>
                </div>
            </div>
            <!-- Infographic Mockup -->
            <div class="flex gap-4 items-center justify-center h-64 bg-gray-900/50 rounded-xl mb-8">
                <!-- Sales Circle -->
                <div id="decision-sales" onclick="selectDecision('sales')"
                    class="text-center p-4 cursor-pointer transition transform hover:scale-105 opacity-100">
                    <div
                        class="w-32 h-32 rounded-full border-8 border-blue-500 flex items-center justify-center text-xl font-bold mb-2 transition-all shadow-[0_0_20px_rgba(59,130,246,0.2)]">
                        ë§¤ì¶œ</div>
                    <span class="text-gray-400 text-sm font-bold">ëª©í‘œ ë‹¬ì„± ìœ ë ¥</span>
                </div>
                <!-- Profit Circle -->
                <div id="decision-profit" onclick="selectDecision('profit')"
                    class="text-center p-4 cursor-pointer transition transform hover:scale-105 opacity-100">
                    <div
                        class="w-32 h-32 rounded-full border-8 border-yellow-500 flex items-center justify-center text-xl font-bold mb-2 transition-all shadow-[0_0_20px_rgba(234,179,8,0.2)]">
                        ì´ìµ</div>
                    <span class="text-gray-400 text-sm font-bold">ë§ˆì§„ìœ¨ 25% ì˜ˆìƒ</span>
                </div>
                <!-- Customer Circle -->
                <div id="decision-customer" onclick="selectDecision('customer')"
                    class="text-center p-4 cursor-pointer transition transform hover:scale-105 opacity-100">
                    <div
                        class="w-32 h-32 rounded-full border-8 border-green-500 flex items-center justify-center text-xl font-bold mb-2 transition-all shadow-[0_0_20px_rgba(34,197,94,0.2)]">
                        ê³ ê°</div>
                    <span class="text-gray-400 text-sm font-bold">ë§Œì¡±ë„ ìµœìƒ</span>
                </div>
            </div>
            <!-- Modified Button Container -->
            <div class="flex justify-between items-center gap-4">
                <!-- Left: Applied Items Button -->
                <button onclick="openAppliedModal()"
                    class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg font-bold transition flex items-center gap-2 border border-gray-600">
                    <span>ğŸ“‹</span> ì ìš©ì‚¬í•­
                </button>

                <!-- Right: Action Buttons -->
                <div class="flex gap-4">
                    <button class="bg-gray-600 hover:bg-gray-500 px-6 py-3 rounded-lg font-bold">ë³´ë¥˜</button>
                    <button onclick="executeStrategy()" id="btn-execute-strategy"
                        class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-bold transition flex items-center gap-2">
                        <span>ğŸš€</span> ì „ëµ ìŠ¹ì¸ ë° ì‹¤í–‰
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- 9. Management Section (Notifications & Settings) -->
    <section class="section">
        <h2
            class="text-4xl font-bold mb-12 text-center text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">
            ìµœì  ìš´ì˜ ì „ëµ ì œì•ˆ (AI)
        </h2>
        <div id="strategy-container" class="max-w-6xl mx-auto w-full px-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Loading Skeleton -->
            <div class="glass p-8 rounded-2xl animate-pulse">
                <div class="h-12 w-12 bg-gray-700 rounded-full mb-6"></div>
                <div class="h-6 w-3/4 bg-gray-700 rounded mb-3"></div>
                <div class="h-4 w-full bg-gray-700 rounded mb-6"></div>
            </div>
            <div class="glass p-8 rounded-2xl animate-pulse">
                <div class="h-12 w-12 bg-gray-700 rounded-full mb-6"></div>
                <div class="h-6 w-3/4 bg-gray-700 rounded mb-3"></div>
                <div class="h-4 w-full bg-gray-700 rounded mb-6"></div>
            </div>
            <div class="glass p-8 rounded-2xl animate-pulse">
                <div class="h-12 w-12 bg-gray-700 rounded-full mb-6"></div>
                <div class="h-6 w-3/4 bg-gray-700 rounded mb-3"></div>
                <div class="h-4 w-full bg-gray-700 rounded mb-6"></div>
            </div>
        </div>
    </section>



    <!-- Modal Container (Dynamic) -->
    <div id="modal-container"></div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <script>
        // --- CSV Upload Logic ---
        function uploadCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            // UI Feedback
            const btn = input.nextElementSibling;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>â³</span> ë¶„ì„ ì¤‘...';
            btn.disabled = true;

            fetch('/api/upload-csv/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update Text & Stats
                    if(document.getElementById('ai-analysis-text')) document.getElementById('ai-analysis-text').innerText = data.analysis;
                    if(document.getElementById('center-cheer-msg')) document.getElementById('center-cheer-msg').innerText = data.cheer_msg;
                    
                    if(document.getElementById('stat-total-revenue')) {
                        document.getElementById('stat-total-revenue').innerText = data.total_revenue.toLocaleString() + 'ì›';
                    }
                    if(document.getElementById('stat-total-orders')) {
                        document.getElementById('stat-total-orders').innerText = data.total_orders.toLocaleString() + 'ê±´';
                    }

                    // Render Chart
                    updateSalesChart(data.labels, data.data); 
                    
                    // Hide waiting overlay
                    const overlay = document.getElementById('chart-overlay-msg');
                    if(overlay) overlay.style.opacity = '0';

                    alert('ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert('ì˜¤ë¥˜: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                input.value = ''; // Reset
            });
        }

        function uploadPastCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const btn = input.nextElementSibling;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>â³</span> ë¹„êµ ì¤‘...';
            btn.disabled = true;

            fetch('/api/upload-past-csv/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(`Server Error (${response.status}): ${text.substring(0, 100)}...`) });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Update Text
                    // Simple MD parser for **
                    let html = data.analysis.replace(/\*\*(.*?)\*\*/g, '<b class="text-purple-300">$1</b>');
                    html = html.replace(/\n/g, '<br>');
                    document.getElementById('past-analysis-text').innerHTML = html;

                    // Render Pie Chart
                    updatePastChart(data.pie_labels, data.pie_data);
                    
                    alert('ë¹„êµ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì˜¤ë¥˜: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                input.value = '';
            });
        }

        function updatePastChart(labels, data) {
            // Transform data for Highcharts: [[name, y], ...]
            const seriesData = labels.map((label, index) => [label, data[index]]);

            Highcharts.chart('pastSalesChart', {
                chart: {
                    type: 'pie',
                    options3d: {
                        enabled: true,
                        alpha: 45,
                        beta: 0
                    },
                    backgroundColor: 'rgba(0,0,0,0)', // Transparent
                    style: {
                        fontFamily: "'Noto Sans KR', sans-serif"
                    }
                },
                title: {
                    text: 'ìƒí’ˆë³„ ë§¤ì¶œ ë¹„ì¤‘',
                    style: {
                        color: '#fff',
                        fontSize: '20px',
                        fontWeight: 'bold'
                    }
                },
                credits: { enabled: false }, // Hide Highcharts watermark
                accessibility: {
                    point: {
                        valueSuffix: '%'
                    }
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        depth: 35,
                        dataLabels: {
                            enabled: true,
                            format: '{point.name}',
                            style: {
                                color: '#e5e7eb', // Text gray-200
                                textOutline: 'none',
                                fontSize: '12px'
                            }
                        }
                    }
                },
                series: [{
                    type: 'pie',
                    name: 'ë§¤ì¶œ ë¹„ì¤‘',
                    data: seriesData,
                    colors: [
                         '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', 
                         '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef'
                    ]
                }]
            });
        }

        function updateSalesChart(labels, data) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (typeof salesChart !== 'undefined' && salesChart) {
                salesChart.destroy();
            } else {
                const existing = Chart.getChart("salesChart");
                if (existing) existing.destroy();
            }

            // Create Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // Blue-500
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

            // Re-create Chart
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì—…ë¡œë“œëœ ë§¤ì¶œ (â‚©)',
                        data: data,
                        borderColor: '#3b82f6', // Blue-500
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#60a5fa',
                        pointBorderColor: '#ffffff',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function (context) {
                                    return ' ' + context.parsed.y.toLocaleString() + 'ì›';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#9ca3af' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        // --- Decision Logic ---
        let selectedDecision = null;

        function selectDecision(type) {
            selectedDecision = type;
            const decisions = ['sales', 'profit', 'customer'];

            decisions.forEach(d => {
                const el = document.getElementById(`decision-${d}`);
                if (d === type) {
                    el.classList.add('scale-110');
                    el.classList.remove('opacity-50');
                    el.querySelector('div').classList.add('ring-4', 'ring-white');
                } else {
                    el.classList.remove('scale-110');
                    el.classList.add('opacity-50');
                    el.querySelector('div').classList.remove('ring-4', 'ring-white');
                }
            });
        }

        function executeStrategy() {
            const btn = document.getElementById('btn-execute-strategy');

            if (!selectedDecision) {
                alert('ë¨¼ì € ì„±ê³µ ì „ëµ(ë§¤ì¶œ, ì´ìµ, ê³ ê°) ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // 1. Loading State
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin">â†»</span> AI ë¶„ì„ ì¤‘...';
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            // 2. Simulate API Call
            setTimeout(() => {
                // 3. Reset Button
                btn.disabled = false;
                btn.innerHTML = '<span>ğŸš€</span> ì „ëµ ìŠ¹ì¸ ë° ì‹¤í–‰';
                btn.classList.remove('opacity-75', 'cursor-not-allowed');

                // 4. Open Modal
                openDecisionModal(selectedDecision);

            }, 1000);
        }

        function openDecisionModal(type) {
            const modal = document.getElementById('decision-modal');
            const content = modal.querySelector('.modal-content');

            // Content Map
            const data = {
                'sales': {
                    icon: 'ğŸ’°',
                    category: 'ë§¤ì¶œ ì„±ì¥ ì „ëµ',
                    title: 'ë§¤ì¶œ ê·¹ëŒ€í™” ì „ëµ',
                    content: `AIê°€ ë¶„ì„í•œ ê²°ê³¼, í˜„ì¬ í…Œì´í¬ì•„ì›ƒ ë§¤ì¶œ ë¹„ì¤‘ì´ ìƒìŠ¹í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n1. íƒ€ì„ ì„¸ì¼: 14:00~16:00 ì‚¬ì´ í…Œì´í¬ì•„ì›ƒ 10% í• ì¸ì„ ì ìš©í•˜ë©´ ë§¤ì¶œ 15% ìƒìŠ¹ì´ ì˜ˆìƒë©ë‹ˆë‹¤.\n2. ì„¸íŠ¸ ë©”ë‰´: ì¸ê¸° ë©”ë‰´ì™€ ìŒë£Œë¥¼ ê²°í•©í•œ '1ì¸ ì„¸íŠ¸'ë¥¼ ì¶œì‹œí•˜ì—¬ ê°ë‹¨ê°€ë¥¼ ë†’ì´ì„¸ìš”.`
                },
                'profit': {
                    icon: 'âš–ï¸',
                    category: 'ë¹„ìš© ìµœì í™”',
                    title: 'ìˆœì´ìµ ê°œì„  ì „ëµ',
                    content: `ì¬ë£Œë¹„ ì ˆê°ì´ í•„ìš”í•œ ì‹œì ì…ë‹ˆë‹¤.\n\n1. ì¬ê³  ìµœì í™”: 'ìš°ìœ ' ì¬ê³ ê°€ ê³¼ë‹¤í•˜ë¯€ë¡œ, ë¼ë–¼ë¥˜ í”„ë¡œëª¨ì…˜ì„ ì§„í–‰í•˜ì—¬ ì†Œì§„ìœ¨ì„ ë†’ì´ì„¸ìš”.\n2. ë¡œìŠ¤ìœ¨ ê´€ë¦¬: ë§ˆê° 1ì‹œê°„ ì „ ì‹ ì„  ì‹í’ˆ 30% í• ì¸ì„ ìë™ ì ìš©í•˜ì—¬ íê¸° ë¹„ìš©ì„ 0ì›ìœ¼ë¡œ ë§Œë“œì‹­ì‹œì˜¤.`
                },
                'customer': {
                    icon: 'ğŸ’–',
                    category: 'ê³ ê° ì¶©ì„±ë„',
                    title: 'ê³ ê° ë§Œì¡± & ì¬ë°©ë¬¸ ìœ ë„',
                    content: `ì‹ ê·œ ê³ ê° ìœ ì…ì€ ì¢‹ìœ¼ë‚˜ ì¬ë°©ë¬¸ìœ¨ì´ 5% ê°ì†Œí–ˆìŠµë‹ˆë‹¤.\n\n1. ë¦¬ë·° ì´ë²¤íŠ¸: ì˜ìˆ˜ì¦ ë¦¬ë·° ì‘ì„± ì‹œ 'ì•„ë©”ë¦¬ì¹´ë…¸ ì¿ í°'ì„ ì¦ì •í•˜ì—¬ ì¬ë°©ë¬¸ ë™ê¸°ë¥¼ ë¶€ì—¬í•˜ì„¸ìš”.\n2. ë‹¨ê³¨ ì¼€ì–´: ì£¼ 3íšŒ ì´ìƒ ë°©ë¬¸ ê³ ê°ì—ê²Œ 'ê°ì‚¬ ì¿ í‚¤'ë¥¼ ì¦ì •í•˜ëŠ” ìº í˜ì¸ì„ ì‹œì‘í•˜ì„¸ìš”.`
                }
            };

            const d = data[type];
            document.getElementById('dm-icon').innerText = d.icon;
            document.getElementById('dm-category').innerText = d.category;
            document.getElementById('dm-title').innerText = d.title;
            document.getElementById('dm-content').innerHTML = d.content;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        // --- Applied History Logic ---
        let appliedStrategies = [];

        // [NEW] Dynamic Strategy Data
        const strategiesData = {
            'sales': [
                {
                    icon: 'ğŸ“¢',
                    title: 'ê¸´ê¸‰ íƒ€ì„ ì„¸ì¼',
                    summary: 'ì˜¤í›„ 2ì‹œ~4ì‹œ í•´í”¼ì•„ì›Œ 15% í• ì¸',
                    score: 92,
                    category: 'ë§¤ì¶œ ë¶€ìŠ¤íŒ…',
                    detail: 'ìœ ë™ ì¸êµ¬ê°€ ë§ì§€ë§Œ ë°©ë¬¸ìœ¨ì´ ë–¨ì–´ì§€ëŠ” ì˜¤í›„ 2ì‹œë¶€í„° 4ì‹œ ì‚¬ì´ì— "í•´í”¼ì•„ì›Œ 15% í• ì¸" ì´ë²¤íŠ¸ë¥¼ ì§„í–‰í•˜ì„¸ìš”.\n\nì˜ˆìƒ íš¨ê³¼: ë°©ë¬¸ê° ìˆ˜ 20% ì¦ê°€, ì¬ê³  ì†Œì§„ìœ¨ 15% ìƒìŠ¹'
                },
                {
                    icon: 'ğŸ°',
                    title: 'ê°ë‹¨ê°€ ìƒìŠ¹ ì„¸íŠ¸',
                    summary: 'ì•„ë©”ë¦¬ì¹´ë…¸ + ì¼€ì´í¬ 1ì¸ ì„¸íŠ¸ ì¶œì‹œ',
                    score: 88,
                    category: 'ë©”ë‰´ ìµœì í™”',
                    detail: 'ë””ì €íŠ¸ íŒë§¤ëŸ‰ì´ ì €ì¡°í•©ë‹ˆë‹¤. ì¸ê¸° ìŒë£Œì¸ ì•„ë©”ë¦¬ì¹´ë…¸ì™€ ì¼€ì´í¬ë¥¼ ë¬¶ì€ "1ì¸ ë‹¬ì½¤ ì„¸íŠ¸"ë¥¼ 500ì› í• ì¸ëœ ê°€ê²©ì— ì¶œì‹œí•˜ì—¬ ê°ë‹¨ê°€ë¥¼ ë†’ì´ì„¸ìš”.\n\nì˜ˆìƒ íš¨ê³¼: ê°ë‹¨ê°€(AOV) 1,500ì› ìƒìŠ¹'
                },
                {
                    icon: 'ğŸ›µ',
                    title: 'ë°°ë‹¬ ì•± ê¹ƒë°œ ìµœì í™”',
                    summary: 'ì£¼ë¬¸ ë°€ì§‘ ì§€ì—­ ê¹ƒë°œ ì¬ë°°ì¹˜',
                    score: 85,
                    category: 'ë°°ë‹¬ ë§ˆì¼€íŒ…',
                    detail: 'ìµœê·¼ 1ê°œì›” ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë¶„ì„í•œ ê²°ê³¼, Cêµ¬ì—­ì˜ ì£¼ë¬¸ëŸ‰ì´ ì¦ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤. íš¨ìœ¨ì´ ë‚®ì€ Aêµ¬ì—­ì˜ ê¹ƒë°œì„ Cêµ¬ì—­ìœ¼ë¡œ ì´ë™ì‹œí‚¤ì„¸ìš”.\n\nì˜ˆìƒ íš¨ê³¼: ë°°ë‹¬ ë…¸ì¶œ ìˆ˜ 30% ì¦ê°€'
                }
            ],
            'profit': [
                {
                    icon: 'ğŸ¥›',
                    title: 'ì¬ê³  ì†Œì§„ í”„ë¡œëª¨ì…˜',
                    summary: 'ìœ í†µê¸°í•œ ì„ë°• ìš°ìœ  í™œìš© ë¼ë–¼ í• ì¸',
                    score: 94,
                    category: 'ì¬ê³  ê´€ë¦¬',
                    detail: 'ìœ í†µê¸°í•œì´ 3ì¼ ë‚¨ì€ ìš°ìœ  ì¬ê³ ê°€ í‰ì†Œë³´ë‹¤ 20% ë§ìŠµë‹ˆë‹¤. "ì˜¤ëŠ˜ì˜ ë¼ë–¼" 10% í• ì¸ í–‰ì‚¬ë¥¼ í†µí•´ ìš°ìœ ë¥¼ ë¹ ë¥´ê²Œ ì†Œì§„í•˜ê³  íê¸° ë¹„ìš©ì„ ì¤„ì´ì„¸ìš”.\n\nì˜ˆìƒ íš¨ê³¼: íê¸°ìœ¨ 0% ë‹¬ì„±, ì›ê°€ ì ˆê°'
                },
                {
                    icon: 'ğŸ‘¥',
                    title: 'ì¸ë ¥ íš¨ìœ¨í™” (ë¸Œë ˆì´í¬)',
                    summary: '15:00~16:00 íŒŒíŠ¸íƒ€ì„ íœ´ê²Œ ì‹œê°„',
                    score: 89,
                    category: 'ì¸ê±´ë¹„ ìµœì í™”',
                    detail: 'í•´ë‹¹ ì‹œê°„ëŒ€ ë§¤ì¶œ ë¶„ì„ ê²°ê³¼, ì¸ê±´ë¹„ ë¹„ì¤‘ì´ 40%ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. 1ì‹œê°„ ë¸Œë ˆì´í¬ íƒ€ì„ì„ ë„ì…í•˜ê±°ë‚˜ íŒŒíŠ¸íƒ€ì„ ê·¼ë¬´ ì‹œê°„ì„ ì¡°ì •í•˜ì—¬ íš¨ìœ¨ì„ ë†’ì´ì„¸ìš”.\n\nì˜ˆìƒ íš¨ê³¼: ì¸ê±´ë¹„ 5% ì ˆê°'
                },
                {
                    icon: 'âš¡',
                    title: 'í”¼í¬íƒ€ì„ ì—ë„ˆì§€ ì ˆì•½',
                    summary: 'ìë™ ëƒ‰ë°© ì˜¨ë„ ì¡°ì ˆ ì‹œìŠ¤í…œ ê°€ë™',
                    score: 82,
                    category: 'ìš´ì˜ ë¹„ìš©',
                    detail: 'í”¼í¬íƒ€ì„ ì „ê¸° ì‚¬ìš©ëŸ‰ì´ ê¸‰ì¦í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë§¤ì¥ ì„¤ì • ì˜¨ë„ë¥¼ 1ë„ ë†’ì´ê³ , AI ìë™ ì œì–´ ì‹œìŠ¤í…œì„ ê°€ë™í•˜ì—¬ ë¶ˆí•„ìš”í•œ ì „ë ¥ ì†Œëª¨ë¥¼ ë§‰ìœ¼ì„¸ìš”.\n\nì˜ˆìƒ íš¨ê³¼: ì›” ì „ê¸°ë£Œ 3% ì ˆê°'
                }
            ],
            'customer': [
                {
                    icon: 'ğŸ‘‘',
                    title: 'ë‹¨ê³¨ ìš°ëŒ€ ìº í˜ì¸',
                    summary: 'ìµœê·¼ 1ë‹¬ ë¯¸ë°©ë¬¸ ë‹¨ê³¨ ì¿ í° ë°œì†¡',
                    score: 95,
                    category: 'CRM ë§ˆì¼€íŒ…',
                    detail: 'ìµœê·¼ 1ë‹¬ê°„ ë°©ë¬¸í•˜ì§€ ì•Šì€ VIP ë“±ê¸‰ ê³ ê° 15ëª…ì—ê²Œ "ì›°ì»´ ë°± ë¬´ë£Œ ì»¤í”¼" ì¿ í°ì„ ë¬¸ìë¡œ ë°œì†¡í•˜ì„¸ìš”. ì¬ë°©ë¬¸ì„ ìœ ë„í•  ìˆ˜ ìˆëŠ” ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•ì…ë‹ˆë‹¤.\n\nì˜ˆìƒ íš¨ê³¼: íœ´ë©´ ê³ ê° 30% ë³µê·€'
                },
                {
                    icon: 'â­',
                    title: 'ì˜ìˆ˜ì¦ ë¦¬ë·° ì´ë²¤íŠ¸',
                    summary: 'í¬í†  ë¦¬ë·° ì‘ì„± ì‹œ ìˆ˜ì œ ì¿ í‚¤ ì¦ì •',
                    score: 90,
                    category: 'ë°”ì´ëŸ´ ë§ˆì¼€íŒ…',
                    detail: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë¦¬ë·° ìˆ˜ê°€ ì •ì²´ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì˜ìˆ˜ì¦ í¬í†  ë¦¬ë·° ì¸ì¦ ì‹œ ë§¤ì¥ì—ì„œ ì§ì ‘ êµ¬ìš´ ì¿ í‚¤ë¥¼ ì„œë¹„ìŠ¤ë¡œ ì œê³µí•˜ì„¸ìš”.\n\nì˜ˆìƒ íš¨ê³¼: ì£¼ê°„ ë¦¬ë·° ìˆ˜ 2ë°° ì¦ê°€'
                },
                {
                    icon: 'ğŸ‚',
                    title: 'ìƒì¼ ì¶•í•˜ ì„œë¹„ìŠ¤',
                    summary: 'ì´ë²ˆ ì£¼ ìƒì¼ ê³ ê° ì¡°ê° ì¼€ì´í¬ ì¦ì •',
                    score: 88,
                    category: 'ê°ë™ ê²½ì˜',
                    detail: 'ì´ë²ˆ ì£¼ ìƒì¼ì„ ë§ì€ ë©¤ë²„ì‹­ ê³ ê° 3ëª…ì´ ìˆìŠµë‹ˆë‹¤. ë°©ë¬¸ ì‹œ ì‹ ë¶„ì¦ í™•ì¸ í›„ ì¡°ê° ì¼€ì´í¬ë¥¼ ì„ ë¬¼í•˜ì—¬ í‰ìƒ ë‹¨ê³¨ë¡œ ë§Œë“œì„¸ìš”.\n\nì˜ˆìƒ íš¨ê³¼: ë¸Œëœë“œ ì¶©ì„±ë„ ê°•í™” ë° ì…ì†Œë¬¸'
                }
            ]
        };

        function updateOperationalStrategies(type) {
            const strategies = strategiesData[type];
            if (!strategies) return;

            const container = document.getElementById('strategy-container');
            const modalContainer = document.getElementById('modal-container');

            // Clear existing
            container.innerHTML = '';

            strategies.forEach((strategy, index) => {
                const modalId = `updated-modal-${type}-${index}`;

                // Card HTML
                const cardHtml = `
                    <div onclick="openStrategyModal('${modalId}')"
                        class="glass p-8 rounded-2xl cursor-pointer hover:bg-white/5 transition transform hover:-translate-y-2 group relative overflow-hidden fade-in">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                        <div class="text-5xl mb-6">${strategy.icon}</div>
                        <h3 class="text-2xl font-bold mb-3 group-hover:text-blue-400 transition">${strategy.title}</h3>
                        <p class="text-gray-300 mb-6">${strategy.summary}</p>
                        <div class="flex items-center gap-2">
                            <div class="flex-1 h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500" style="width: ${strategy.score}%;"></div>
                            </div>
                            <span class="text-sm text-blue-400 font-bold">${strategy.score}ì </span>
                        </div>
                        <div class="mt-6 text-sm text-gray-400 group-hover:text-white transition flex items-center justify-end gap-1">
                            ìƒì„¸ë³´ê¸° <span>â†’</span>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);

                // Check if modal already exists (to prevent dupes on multiple clicks)
                if (!document.getElementById(modalId)) {
                    // Modal HTML
                    const modalHtml = `
                        <div id="${modalId}" class="fixed inset-0 z-[100] hidden items-center justify-center">
                            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeStrategyModal('${modalId}')"></div>
                            <div class="relative glass bg-gray-900 border border-gray-700 p-8 md:p-12 rounded-2xl max-w-2xl w-full mx-4 shadow-2xl transform transition-all scale-95 opacity-0 modal-content">
                                <button onclick="closeStrategyModal('${modalId}')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
                                <div class="flex items-center gap-4 mb-6">
                                    <span class="text-6xl">${strategy.icon}</span>
                                    <div>
                                        <span class="text-blue-400 font-bold uppercase tracking-wider text-sm">${strategy.category}</span>
                                        <h3 class="text-3xl font-bold mt-1">${strategy.title}</h3>
                                    </div>
                                </div>
                                <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50 mb-8">
                                    <p class="text-gray-300 text-lg leading-relaxed whitespace-pre-line">${strategy.detail}</p>
                                </div>
                                <div class="flex justify-end gap-4">
                                    <button onclick="closeStrategyModal('${modalId}')" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-bold transition">ë‹«ê¸°</button>
                                    <button class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-bold transition">ì „ëµ ì‹¤í–‰í•˜ê¸°</button>
                                </div>
                            </div>
                        </div>
                    `;
                    modalContainer.insertAdjacentHTML('beforeend', modalHtml);
                }
            });

            // Scroll to the section to show the update (Visual Feedback)
            const strategySection = document.querySelector('.section:nth-of-type(7)'); // It matches the 'Operational Strategy' section now
            if (strategySection) {
                // precise scroll after a short delay
                setTimeout(() => {
                    strategySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 500);
            }
        }

        function undoLastStrategy() {
            if (appliedStrategies.length === 0) {
                alert('ì·¨ì†Œí•  ì‹¤í–‰ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // 1. Remove Last Item
            const removed = appliedStrategies.pop();

            // 2. Identify Type (Reverse lookup or store type in appliedStrategies)
            // Ideally we stored type. Since we didn't, let's infer from title or just iterate types.
            // Wait, we didn't store 'type' (sales/profit/customer) in appliedStrategies object! 
            // We should have. But we can recover it by matching title.
            let typeToReset = null;
            for (const [key, value] of Object.entries({
                'sales': 'ë§¤ì¶œ ê·¹ëŒ€í™” ì „ëµ',
                'profit': 'ìˆœì´ìµ ê°œì„  ì „ëµ',
                'customer': 'ê³ ê° ë§Œì¡± & ì¬ë°©ë¬¸ ìœ ë„'
            })) {
                if (value === removed.title) {
                    typeToReset = key;
                    break;
                }
            }

            // 3. Reset Circle UI
            if (typeToReset) {
                resetDecisionCircle(typeToReset);
            }

            // 4. Update Modal List
            openAppliedModal(); // Re-render list

            // 5. Clear Operational Strategies Section
            document.getElementById('strategy-container').innerHTML = `
                <div class="col-span-3 glass p-8 rounded-xl text-center text-gray-500 py-20">
                    ì „ëµì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì „ëµì„ ì„ íƒí•´ì£¼ì„¸ìš”.
                </div>
            `;

            // 6. Toast Feedback
            const toast = document.createElement('div');
            toast.className = 'fixed top-10 right-10 bg-red-500/90 backdrop-blur-md text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 fade-in z-[300] border border-red-400/50';
            toast.innerHTML = `
                <div class="text-2xl">â†©ï¸</div>
                <div>
                    <h4 class="font-bold text-lg text-white">ì „ëµ ì‹¤í–‰ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.</h4>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function resetDecisionCircle(type) {
            const circleEl = document.getElementById(`decision-${type}`);
            if (!circleEl) return;

            const circleInner = circleEl.querySelector('div');
            const labelSpan = circleEl.querySelector('span');

            // Reset Styles
            circleInner.classList.remove('border-white', 'bg-green-500/20', 'animate-pulse');

            // Restore Original Color
            if (type === 'sales') circleInner.classList.add('border-blue-500');
            if (type === 'profit') circleInner.classList.add('border-yellow-500');
            if (type === 'customer') circleInner.classList.add('border-green-500');

            // Restore Text
            const originalText = {
                'sales': 'ë§¤ì¶œ',
                'profit': 'ì´ìµ',
                'customer': 'ê³ ê°'
            }[type];
            circleInner.innerHTML = originalText;

            // Restore Label
            labelSpan.classList.remove('text-green-400', 'font-bold');
            labelSpan.innerText = {
                'sales': 'ëª©í‘œ ë‹¬ì„± ìœ ë ¥',
                'profit': 'ë§ˆì§„ìœ¨ 25% ì˜ˆìƒ',
                'customer': 'ë§Œì¡±ë„ ìµœìƒ'
            }[type];

            // Re-enable Interaction
            circleEl.onclick = function () { selectDecision(type); };
            circleEl.classList.add('cursor-pointer', 'hover:scale-105');
            circleEl.classList.remove('cursor-default');
        }

        function openAppliedModal() {
            const modal = document.getElementById('applied-modal');
            const content = modal.querySelector('.modal-content');
            const listEl = document.getElementById('applied-list');

            // Render List
            if (appliedStrategies.length > 0) {
                listEl.innerHTML = appliedStrategies.map((item, index) => `
                    <li class="bg-gray-700/50 p-4 rounded-lg border border-gray-600 flex items-start gap-4">
                        <span class="text-2xl">${item.icon}</span>
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-blue-400 px-2 py-0.5 rounded bg-blue-900/30 border border-blue-500/30">${item.category}</span>
                                <span class="text-xs text-gray-400">${item.date}</span>
                            </div>
                            <h4 class="font-bold text-white text-lg">${item.title}</h4>
                            <p class="text-sm text-gray-300 mt-1">ìƒíƒœ: <span class="text-green-400 font-bold">ì‹¤í–‰ ì¤‘ (D+1)</span></p>
                        </div>
                    </li>
                `).join('');
            } else {
                listEl.innerHTML = '<li class="text-gray-500 text-center py-8">ì•„ì§ ì ìš©ëœ ì „ëµì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeAppliedModal() {
            const modal = document.getElementById('applied-modal');
            const content = modal.querySelector('.modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        function closeDecisionModal() {
            const modal = document.getElementById('decision-modal');
            const content = modal.querySelector('.modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        function applyDecisionStrategy() {
            const btn = document.getElementById('btn-apply-decision');

            // 1. Loading State
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin">â†»</span> ì ìš© ì¤‘...';
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            // 2. Simulate API Call
            setTimeout(() => {
                // 3. Success State
                btn.innerHTML = '<span>âœ…</span> ì ìš© ì™„ë£Œ';
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                btn.classList.add('bg-green-600', 'hover:bg-green-500');

                // 4. Update Circle UI (Verification Feature)
                const circleEl = document.getElementById(`decision-${selectedDecision}`);
                if (circleEl) {
                    const circleInner = circleEl.querySelector('div');
                    const labelSpan = circleEl.querySelector('span');

                    // Change Style
                    circleInner.classList.remove('border-blue-500', 'border-yellow-500', 'border-green-500');
                    circleInner.classList.add('border-white', 'bg-green-500/20', 'animate-pulse');
                    circleInner.innerHTML = 'âœ…<br>ì ìš©ë¨'; // Change Icon/Text

                    // Update Label
                    labelSpan.innerText = 'ì „ëµ ì‹¤í–‰ ì¤‘';
                    labelSpan.classList.add('text-green-400', 'font-bold');

                    // Disable Interaction
                    circleEl.onclick = null;
                    circleEl.classList.remove('cursor-pointer', 'hover:scale-105');
                    circleEl.classList.add('cursor-default');
                }

                // [NEW] Update Operational Strategies (Dynamic Cards)
                updateOperationalStrategies(selectedDecision);

                // [NEW] Add to Applied History
                const data = {
                    'sales': { icon: 'ğŸ’°', category: 'ë§¤ì¶œ ì„±ì¥ ì „ëµ', title: 'ë§¤ì¶œ ê·¹ëŒ€í™” ì „ëµ' },
                    'profit': { icon: 'âš–ï¸', category: 'ë¹„ìš© ìµœì í™”', title: 'ìˆœì´ìµ ê°œì„  ì „ëµ' },
                    'customer': { icon: 'ğŸ’–', category: 'ê³ ê° ì¶©ì„±ë„', title: 'ê³ ê° ë§Œì¡± & ì¬ë°©ë¬¸ ìœ ë„' }
                };

                const currentData = data[selectedDecision];
                if (currentData) {
                    // Check duplicate (optional, but good for safety)
                    const exists = appliedStrategies.find(s => s.title === currentData.title);
                    if (!exists) {
                        appliedStrategies.push({
                            icon: currentData.icon,
                            category: currentData.category,
                            title: currentData.title,
                            date: new Date().toLocaleDateString()
                        });
                    }
                }

                // 5. Show Toast
                const toast = document.createElement('div');
                toast.className = 'fixed top-10 right-10 bg-green-500/90 backdrop-blur-md text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 fade-in z-[300] border border-green-400/50';
                toast.innerHTML = `
                    <div class="text-3xl">ğŸ‰</div>
                    <div>
                        <h4 class="font-bold text-lg text-white">ì „ëµì´ ì„±ê³µì ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!</h4>
                        <p class="text-sm text-green-100 mt-1">ì˜ˆìƒ íš¨ê³¼: ë‹¤ìŒ ë‹¬ ë§¤ì¶œ +15% ìƒìŠ¹</p>
                    </div>
                `;
                document.body.appendChild(toast);

                // 6. Close Modal & Reset
                setTimeout(() => {
                    closeDecisionModal();

                    // Reset Button (after modal closes)
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = 'ì „ëµ ì ìš©í•˜ê¸°';
                        btn.classList.remove('bg-green-600', 'hover:bg-green-500', 'opacity-75', 'cursor-not-allowed');
                        btn.classList.add('bg-blue-600', 'hover:bg-blue-500');
                    }, 500);

                    // Remove toast
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 500);
                    }, 3000);
                }, 1000);

            }, 1500);
        }

        function openStrategyModal(modalId) {
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('.modal-content');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeStrategyModal(modalId) {
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('.modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        // Render Chart Function
        let salesChart = null;
        function renderSalesChart(hourlyData) {
            const ctx = document.getElementById('salesChart').getContext('2d');

            // Generate labels for 24h
            const labels = Array.from({ length: 24 }, (_, i) => i + 'ì‹œ');

            // Gradient fill
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // Blue-500
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

            if (salesChart) salesChart.destroy();

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì‹œê°„ëŒ€ë³„ ì˜ˆìƒ ë§¤ì¶œ (â‚©)',
                        data: hourlyData,
                        borderColor: '#3b82f6', // Blue-500
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#60a5fa',
                        pointBorderColor: '#ffffff',
                        tension: 0.4, // Smooth curve
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function (context) {
                                    return ' ' + context.parsed.y.toLocaleString() + 'ì›';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'nearest',
                    },
                }
            });
        }

        // Render Weekly Trend Chart (Highcharts - Premium Area Spline)
        function renderWeeklyTrendChart(pastData) {
            // Get last 7 days only
            const dates = pastData.dates.slice(-7);
            const revenues = pastData.revenues.slice(-7);

            Highcharts.chart('weeklyTrendChart', {
                chart: {
                    type: 'areaspline',
                    backgroundColor: 'transparent',
                    style: {
                        fontFamily: "'Inter', 'Noto Sans KR', sans-serif"
                    },
                    spacingBottom: 30
                },
                title: { text: null },
                credits: { enabled: false },
                xAxis: {
                    categories: dates,
                    gridLineWidth: 0,
                    lineWidth: 0,
                    labels: {
                        style: { color: '#64748b', fontWeight: 'bold' }
                    }
                },
                yAxis: {
                    title: { text: null },
                    gridLineColor: 'rgba(255, 255, 255, 0.05)',
                    labels: {
                        enabled: true,
                        style: { color: '#475569' },
                        formatter: function() {
                            return (this.value / 10000).toLocaleString() + 'ë§Œ';
                        }
                    }
                },
                tooltip: {
                    shared: true,
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    borderColor: '#6366f1',
                    borderRadius: 12,
                    style: { color: '#f8fafc' },
                    headerFormat: '<span style="font-size: 10px; color: #94a3b8">{point.key} ë§¤ì¶œë¦¬í¬íŠ¸</span><br/>',
                    pointFormat: '<span style="color:{point.color}">â—</span> {series.name}: <b>â‚© {point.y:,.0f}ì›</b>'
                },
                plotOptions: {
                    areaspline: {
                        fillColor: {
                            linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                            stops: [
                                [0, 'rgba(99, 102, 241, 0.3)'],
                                [1, 'rgba(99, 102, 241, 0)']
                            ]
                        },
                        marker: {
                            radius: 4,
                            fillColor: '#6366f1',
                            lineWidth: 2,
                            lineColor: '#ffffff'
                        },
                        lineWidth: 3,
                        lineColor: '#6366f1',
                        states: {
                            hover: { lineWidth: 4 }
                        }
                    }
                },
                series: [{
                    name: 'ì¼ë³„ ì´ ë§¤ì¶œ',
                    data: revenues
                }]
            });

            // Hide loading
            const loading = document.getElementById('weekly-chart-loading');
            if(loading) loading.style.opacity = '0';
            setTimeout(() => { if(loading) loading.classList.add('hidden'); }, 500);
        }

        // AJAX Fetcher
        document.addEventListener('DOMContentLoaded', function () {
            fetch("{% url 'dashboard_stats_api' %}")
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 1. Update Prediction
                        document.getElementById('prediction-value').innerText = 'â‚© ' + Number(data.prediction).toLocaleString();
                        document.getElementById('prediction-status').innerHTML = '<span>âœ…</span> <span>ë¶„ì„ ì™„ë£Œ</span>';

                        // 2. Update Weather
                        if (data.weather.condition) {
                            document.getElementById('weather-cond').innerText = data.weather.condition;
                            document.getElementById('weather-temp').innerText = data.weather.temp + 'Â°';
                        }

                        // 3. Update Analysis Text
                        document.getElementById('ai-analysis-text').innerText = data.analysis;

                        // 4. Update Cheer Message
                        document.getElementById('ai-cheer-msg').innerText = '"' + data.cheer_msg + '"';
                        // [NEW] Update Center Cheer Msg
                        const centerMsg = document.getElementById('center-cheer-msg');
                        if (centerMsg) centerMsg.innerText = data.cheer_msg;

                        // 5. Render Charts
                        if (data.hourly_sales) {
                            renderSalesChart(data.hourly_sales);
                        }
                        if (data.past_sales) {
                            renderWeeklyTrendChart(data.past_sales);
                        }


                        // [NEW] Update Past Analysis Text
                        if (data.past_analysis) {
                            // Convert markdown-style bold to HTML bold
                            const formattedAnalysis = data.past_analysis.replace(/\*\*(.*?)\*\*/g, '<b class="text-purple-400">$1</b>');
                            document.getElementById('past-analysis-text').innerHTML = formattedAnalysis;
                        }

                        // 6. Update Strategy Cards
                        const container = document.getElementById('strategy-container');
                        const modalContainer = document.getElementById('modal-container');
                        container.innerHTML = ''; // Clear skeleton

                        data.strategies.forEach((strategy, index) => {
                            const modalId = `modal-${index}`;

                            // Card HTML
                            const cardHtml = `
                                <div onclick="openStrategyModal('${modalId}')"
                                    class="glass p-8 rounded-2xl cursor-pointer hover:bg-white/5 transition transform hover:-translate-y-2 group relative overflow-hidden">
                                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                                    <div class="text-5xl mb-6">${strategy.icon}</div>
                                    <h3 class="text-2xl font-bold mb-3 group-hover:text-blue-400 transition">${strategy.title}</h3>
                                    <p class="text-gray-400 mb-6">${strategy.summary}</p>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 h-2 bg-gray-700 rounded-full overflow-hidden">
                                            <div class="h-full bg-blue-500" style="width: ${strategy.score}%;"></div>
                                        </div>
                                        <span class="text-sm text-blue-400 font-bold">${strategy.score}ì </span>
                                    </div>
                                    <div class="mt-6 text-sm text-gray-500 group-hover:text-white transition flex items-center justify-end gap-1">
                                        ìƒì„¸ë³´ê¸° <span>â†’</span>
                                    </div>
                                </div>
                            `;
                            container.insertAdjacentHTML('beforeend', cardHtml);

                            // Modal HTML
                            const modalHtml = `
                                <div id="${modalId}" class="fixed inset-0 z-[100] hidden items-center justify-center">
                                    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeStrategyModal('${modalId}')"></div>
                                    <div class="relative glass bg-gray-900 border border-gray-700 p-8 md:p-12 rounded-2xl max-w-2xl w-full mx-4 shadow-2xl transform transition-all scale-95 opacity-0 modal-content">
                                        <button onclick="closeStrategyModal('${modalId}')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
                                        <div class="flex items-center gap-4 mb-6">
                                            <span class="text-6xl">${strategy.icon}</span>
                                            <div>
                                                <span class="text-blue-400 font-bold uppercase tracking-wider text-sm">${strategy.category}</span>
                                                <h3 class="text-3xl font-bold mt-1">${strategy.title}</h3>
                                            </div>
                                        </div>
                                        <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50 mb-8">
                                            <p class="text-gray-300 text-lg leading-relaxed whitespace-pre-line">${strategy.detail}</p>
                                        </div>
                                        <div class="flex justify-end gap-4">
                                            <button onclick="closeStrategyModal('${modalId}')" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-bold transition">ë‹«ê¸°</button>
                                            <button class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-bold transition">ì „ëµ ì‹¤í–‰í•˜ê¸°</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            modalContainer.insertAdjacentHTML('beforeend', modalHtml);
                        });
                    } else {
                        throw new Error(data.message || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error fetching dashboard stats:', error);
                    document.getElementById('ai-analysis-text').innerText = "AI ë¶„ì„ ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                    document.getElementById('prediction-value').innerText = "ë¶„ì„ ì‹¤íŒ¨";
                    document.getElementById('prediction-status').innerHTML = '<span>âš ï¸</span> <span>ì—°ê²° ì˜¤ë¥˜</span>';
                    // Error state for chart
                    const ctx = document.getElementById('salesChart').getContext('2d');
                    ctx.font = "14px 'Noto Sans KR'";
                    ctx.fillStyle = "gray";
                    ctx.textAlign = "center";
                    ctx.fillText("ë§¤ì¶œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", ctx.canvas.width / 2, ctx.canvas.height / 2);

                    document.getElementById('strategy-container').innerHTML = `
                        <div class="col-span-3 glass p-8 rounded-xl text-center text-gray-400">
                             ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>(${error.message})
                        </div>
                    `;
                });
        });
    </script>



    <!-- Applied History Modal -->
    <div id="applied-modal" class="fixed inset-0 z-[200] hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeAppliedModal()"></div>
        <div
            class="relative glass bg-gray-900 border border-gray-700 p-8 rounded-2xl max-w-2xl w-full mx-4 shadow-2xl transform transition-all scale-95 opacity-0 modal-content">
            <button onclick="closeAppliedModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <span>ğŸ“‹</span> í˜„ì¬ ì ìš©ëœ ì „ëµ ëª©ë¡
            </h3>

            <div class="bg-gray-800/50 rounded-xl p-6 min-h-[200px] max-h-[400px] overflow-y-auto custom-scrollbar">
                <ul id="applied-list" class="space-y-4">
                    <!-- Items injected here -->
                    <li class="text-gray-500 text-center py-8">ì•„ì§ ì ìš©ëœ ì „ëµì´ ì—†ìŠµë‹ˆë‹¤.</li>
                </ul>
            </div>

            <div class="flex justify-end mt-6 gap-3">
                <button onclick="undoLastStrategy()"
                    class="px-6 py-3 bg-red-600/80 hover:bg-red-500 rounded-lg text-white font-bold transition flex items-center gap-2">
                    <span>â†©ï¸</span> ì‹¤í–‰ ì·¨ì†Œ
                </button>
                <button onclick="closeAppliedModal()"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-bold transition">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Decision Modal (AI Strategy Proposal) -->
    <div id="decision-modal" class="fixed inset-0 z-[200] hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeDecisionModal()"></div>
        <div
            class="relative glass bg-gray-900 border border-gray-700 p-8 md:p-12 rounded-2xl max-w-2xl w-full mx-4 shadow-2xl transform transition-all scale-95 opacity-0 modal-content">
            <button onclick="closeDecisionModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <div class="flex items-center gap-4 mb-6">
                <span id="dm-icon" class="text-6xl"></span>
                <div>
                    <span id="dm-category" class="text-blue-400 font-bold uppercase tracking-wider text-sm"></span>
                    <h3 id="dm-title" class="text-3xl font-bold mt-1"></h3>
                </div>
            </div>
            <div id="dm-content"
                class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50 mb-8 text-gray-300 text-lg leading-relaxed whitespace-pre-line">
            </div>
            <div class="flex justify-end gap-4">
                <button onclick="closeDecisionModal()"
                    class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-bold transition">ë‹«ê¸°</button>
                <button id="btn-apply-decision" onclick="applyDecisionStrategy()"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-bold transition flex items-center gap-2">
                    <span>ğŸš€</span> ì „ëµ ì ìš©
                </button>
            </div>
        </div>
    </div>

    <!-- 8. Emotional Care -->
    <section class="section bg-gradient-to-b from-gray-900 to-indigo-900 text-center">
        <div class="max-w-5xl mx-auto px-6">
            <div class="mb-8">
                <span class="text-6xl">ğŸŒ¿</span>
            </div>
            <h2 class="text-4xl font-bold mb-8">ì‚¬ì¥ë‹˜, ì˜¤ëŠ˜ë„ ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ì–´ìš”.</h2>
            <div class="glass p-10 rounded-2xl mb-8 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-indigo-500"></div>
                <p id="ai-cheer-msg" class="text-2xl italic text-gray-200 leading-relaxed">
                    {% if ai_cheer_msg %}
                    "{{ ai_cheer_msg }}"
                    {% else %}
                    <span class="animate-pulse">"ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³  ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤. AIê°€ ë©”ì‹œì§€ë¥¼ ì‘ì„±ì¤‘ì…ë‹ˆë‹¤..."</span>
                    {% endif %}
                </p>
                <p class="text-right text-gray-400 mt-4">- AI ê°ì„± ì¼€ì–´</p>
            </div>
            <button onclick="openHealingOverlay()"
                class="bg-white/10 hover:bg-white/20 px-8 py-4 rounded-full text-lg transition backdrop-blur-md">
                â˜• AI ë§ì¶¤í˜• íë§ ë©”ì‹œì§€ ë”ë³´ê¸°
            </button>
        </div>
    </section>

    <!-- 9. Community & Consultation -->
    <section class="section bg-gray-900">
        <div class="max-w-7xl mx-auto w-full grid grid-cols-1 md:grid-cols-2 gap-12 px-6">
            <!-- Community -->
            <div>
                <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
                    <span>ğŸ’¬</span> ì‚¬ì¥ë‹˜ ì†Œí†µë°©
                </h2>
                <div class="space-y-4">
                    {% for post in recent_posts %}
                    <div class="glass p-4 rounded-xl">
                        <div class="flex justify-between text-sm text-gray-400 mb-2">
                            <span>{{ post.author }}</span>
                            <span>{{ post.created_at|timesince }} ì „</span>
                        </div>
                        <p>{{ post.content }}</p>
                    </div>
                    {% empty %}
                    <div class="glass p-4 rounded-xl text-center text-gray-500">
                        ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!
                    </div>
                    {% endfor %}
                    <button class="w-full py-3 bg-gray-800 rounded-xl hover:bg-gray-700 transition">ì»¤ë®¤ë‹ˆí‹° ì…ì¥í•˜ê¸°</button>
                </div>
            </div>

            <!-- AI Consultation -->
            <div class="glass p-8 rounded-2xl bg-blue-900/20 border-blue-500/30">
                <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
                    <span>ğŸ¤–</span> AI ì†”ë£¨ì…˜ ìƒë‹´
                </h2>
                <p class="text-gray-300 mb-8">ë§¤ì¥ ìš´ì˜ ì¤‘ ë°œìƒí•˜ëŠ” ëª¨ë“  ë¬¸ì œ, AI ë¹„ì„œì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”. ë²•ë¥ , ì„¸ë¬´, ë…¸ë¬´, ë§ˆì¼€íŒ…ê¹Œì§€ ì¦‰ì‹œ ë‹µë³€ë“œë¦½ë‹ˆë‹¤.</p>

                <div class="bg-black/40 p-4 rounded-xl h-48 mb-4 overflow-y-auto">
                    <div class="text-right mb-2"><span
                            class="bg-blue-600 px-3 py-1 rounded-lg text-sm inline-block">ì•Œë°”ìƒì´ ê°‘ìê¸° ê·¸ë§Œë’€ëŠ”ë° ê¸‰ì—¬ ì²˜ë¦¬ëŠ”?</span>
                    </div>
                    <div class="text-left mb-2"><span
                            class="bg-gray-700 px-3 py-1 rounded-lg text-sm inline-block">ê·¼ë¡œê¸°ì¤€ë²•ì— ë”°ë¥´ë©´... (AI ë‹µë³€)</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <input type="text" placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”..."
                        class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                    <button class="bg-blue-600 px-6 py-2 rounded-lg font-bold">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-black py-12 text-center text-gray-500 text-sm">
        <p class="mb-4">&copy; 2024 Forkast AI. All rights reserved.</p>
        <div class="flex justify-center gap-6">
            <a href="#" class="hover:text-white">ì´ìš©ì•½ê´€</a>
            <a href="#" class="hover:text-white">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
            <a href="#" class="hover:text-white">ê³ ê°ì„¼í„°</a>
        </div>
    </footer>

    <!-- Decision Modal -->
    <div id="decision-modal" class="fixed inset-0 z-[200] hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeDecisionModal()"></div>
        <div
            class="relative glass bg-gray-900 border border-gray-700 p-8 md:p-12 rounded-2xl max-w-3xl w-full mx-4 shadow-2xl transform transition-all scale-95 opacity-0 modal-content">
            <button onclick="closeDecisionModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <div class="flex items-center gap-4 mb-6">
                <span id="dm-icon" class="text-6xl">ğŸ¤–</span>
                <div>
                    <span id="dm-category"
                        class="text-blue-400 font-bold uppercase tracking-wider text-sm">Category</span>
                    <h3 id="dm-title" class="text-3xl font-bold mt-1">Title</h3>
                </div>
            </div>
            <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50 mb-8">
                <div id="dm-content" class="text-gray-300 text-lg leading-relaxed whitespace-pre-line">Content</div>
            </div>
            <div class="flex justify-end gap-4">
                <button onclick="closeDecisionModal()"
                    class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-bold transition">ë‹«ê¸°</button>
                <button onclick="applyDecisionStrategy()" id="btn-apply-decision"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-bold transition">ì „ëµ
                    ì ìš©í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div id="video-modal" class="fixed inset-0 z-[200] hidden items-center justify-center bg-black/95 backdrop-blur-md">
        <button onclick="closeVideoModal()"
            class="absolute top-6 right-6 text-white/50 hover:text-white text-4xl font-light transition z-50">&times;</button>
        <div class="w-full max-w-6xl aspect-video relative mx-4 shadow-2xl rounded-xl overflow-hidden bg-black">
            <video id="modal-video-player" class="w-full h-full object-contain" controls>
                <source src="" type="video/mp4">
            </video>
        </div>
    </div>

    <!-- Healing Overlay -->
    <div id="healing-overlay"
        class="fixed inset-0 z-[300] hidden flex-col items-center justify-center bg-gray-900 healing-gradient transition-opacity duration-1000 opacity-0">
        <!-- Close Button -->
        <button onclick="closeHealingOverlay()"
            class="absolute top-8 right-8 text-white/50 hover:text-white text-2xl z-50 transition">
            <span class="border border-white/30 rounded-full px-4 py-1 text-sm">Esc / ë‹«ê¸°</span>
        </button>

        <!-- Audio Player -->
        <audio id="healing-audio" loop>
            <!-- Try OGG first, then MP3 -->
            <source src="{% static 'music/healing_bgm.ogg' %}" type="audio/ogg">
            <source src="{% static 'music/healing_bgm.mp3' %}" type="audio/mpeg">
        </audio>

        <!-- Particles Container -->
        <div id="particles-container" class="absolute inset-0 pointer-events-none overflow-hidden z-0"></div>

        <!-- Content -->
        <div class="relative z-10 max-w-4xl px-8 text-center fade-in">
            <div class="mb-12">
                <span class="text-7xl animate-bounce inline-block">ğŸŒŸ</span>
            </div>
            <h2 class="text-xl md:text-2xl text-blue-200 font-light mb-8 tracking-[0.2em] uppercase">Today's Message
            </h2>
            <p id="healing-overlay-text"
                class="text-3xl md:text-5xl lg:text-6xl font-bold text-white leading-tight drop-shadow-2xl font-serif">
                "ì ì‹œë§Œìš”, ë‹¹ì‹ ì„ ìœ„í•œ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤..."
            </p>
            <div class="mt-16 opacity-60 text-sm mb-8">
                ì ì‹œ ëˆˆì„ ê°ê³  í¸ì•ˆí•œ ë§ˆìŒì„ ê°€ì ¸ë³´ì„¸ìš”.
            </div>

            <!-- Music Controls -->
            <div class="mb-8 flex flex-col items-center gap-4">
                <div class="inline-flex items-center gap-4 bg-white/10 backdrop-blur-md px-6 py-2 rounded-full border border-white/20 hover:bg-white/20 transition cursor-pointer"
                    onclick="toggleAudio()">
                    <button id="btn-audio-toggle"
                        class="text-white hover:text-blue-300 transition text-2xl flex items-center gap-2">
                        <span id="audio-icon">ğŸ”‡</span>
                        <span id="audio-label" class="text-sm font-light">Music Off (Click to Play)</span>
                    </button>
                </div>

                <!-- YouTube Warning/Status -->
                <div id="yt-status" class="text-xs text-blue-200 hidden">â–¶ YouTube Playing...</div>
            </div>

            <!-- YouTube Playlist Section -->
            <div class="max-w-lg mx-auto bg-black/30 p-6 rounded-xl backdrop-blur-sm border border-white/10">
                <h3 class="text-blue-200 text-sm font-bold uppercase mb-4 tracking-wider">ğŸŒŸ My Healing Playlist</h3>

                <!-- Input Area -->
                <div class="flex gap-2 mb-4">
                    <input id="yt-input-title" type="text" placeholder="ì œëª© (ì˜ˆ: ë¹—ì†Œë¦¬)"
                        class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-400 w-1/3">
                    <input id="yt-input-url" type="text" placeholder="YouTube ë§í¬ ë¶™ì—¬ë„£ê¸°"
                        class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-400 flex-1">
                    <button onclick="addToPlaylist()"
                        class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition">+</button>
                </div>

                <!-- Playlist -->
                <ul id="yt-playlist" class="text-left space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                    <!-- Items will be injected here -->
                    <li class="text-gray-400 text-xs text-center py-2">ì €ì¥ëœ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                </ul>
            </div>

            <!-- Hidden YouTube Player Div -->
            <div id="youtube-player" class="hidden"></div>
        </div>
    </div>

    <script>
        function openVideoModal(videoSrc) {
            const modal = document.getElementById('video-modal');
            const player = document.getElementById('modal-video-player');

            player.src = videoSrc;
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Auto play
            player.play().catch(e => console.log('Auto-play blocked:', e));
            document.body.style.overflow = 'hidden';
        }

        function closeVideoModal() {
            const modal = document.getElementById('video-modal');
            const player = document.getElementById('modal-video-player');

            player.pause();
            player.currentTime = 0;
            player.src = ""; // Stop buffering

            modal.classList.remove('flex');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Close on clicking outside
        document.getElementById('video-modal').addEventListener('click', (e) => {
            if (e.target.id === 'video-modal') closeVideoModal();
        });

        // --- Healing Overlay Logic ---
        const healingAudio = document.getElementById('healing-audio');
        let isMusicPlaying = false;
        let currentSource = 'local'; // 'local' or 'youtube'
        let ytPlayer = null;
        let isYtReady = false;
        let fireworkInterval = null; // To store loop ID

        // 1. YouTube Iframe API Setup
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtube-player', {
                height: '0',
                width: '0',
                playerVars: {
                    'playsinline': 1,
                    'controls': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            isYtReady = true;
        }

        function onPlayerStateChange(event) {
            // Optional: Handle state changes
            if (event.data === YT.PlayerState.ENDED) {
                isMusicPlaying = false;
                updateAudioUI(false, 'YouTube Ended');
            }
        }

        // 2. Playlist Logic
        function loadPlaylist() {
            const list = JSON.parse(localStorage.getItem('healingPlaylist') || '[]');
            renderPlaylistUI(list);
        }

        function addToPlaylist() {
            const titleInput = document.getElementById('yt-input-title');
            const urlInput = document.getElementById('yt-input-url');
            const title = titleInput.value.trim();
            const url = urlInput.value.trim();

            if (!title || !url) return alert('ì œëª©ê³¼ ë§í¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            // Extract ID
            let videoId = '';
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) {
                videoId = match[2];
            } else {
                return alert('ì˜¬ë°”ë¥¸ YouTube ë§í¬ê°€ ì•„ë‹™ë‹ˆë‹¤.');
            }

            const list = JSON.parse(localStorage.getItem('healingPlaylist') || '[]');
            list.push({ title, id: videoId });
            localStorage.setItem('healingPlaylist', JSON.stringify(list));

            titleInput.value = '';
            urlInput.value = '';
            renderPlaylistUI(list);
        }

        function removeFromPlaylist(index) {
            const list = JSON.parse(localStorage.getItem('healingPlaylist') || '[]');
            list.splice(index, 1);
            localStorage.setItem('healingPlaylist', JSON.stringify(list));
            renderPlaylistUI(list);
        }

        function renderPlaylistUI(list) {
            const ul = document.getElementById('yt-playlist');
            ul.innerHTML = '';

            if (list.length === 0) {
                ul.innerHTML = '<li class="text-gray-400 text-xs text-center py-2">ë§í¬ë¥¼ ì¶”ê°€í•˜ì—¬ ë‚˜ë§Œì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</li>';
                return;
            }

            list.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between group cursor-pointer bg-white/5 hover:bg-white/10 rounded px-3 py-2 transition';
                li.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden" onclick="playYouTube('${item.id}', '${item.title}')">
                        <span class="text-blue-400">â–¶</span>
                        <span class="text-sm text-gray-200 truncate font-medium group-hover:text-white transition">${item.title}</span>
                    </div>
                    <button onclick="removeFromPlaylist(${index})" class="text-gray-600 hover:text-red-400 px-2">Ã—</button>
                `;
                ul.appendChild(li);
            });
        }

        // 3. Audio Control Logic (Hybrid)
        function openHealingOverlay() {
            const overlay = document.getElementById('healing-overlay');
            const msgSource = document.getElementById('ai-cheer-msg');
            const targetText = document.getElementById('healing-overlay-text');

            // Clean text
            let msg = msgSource.innerText.trim();
            if (msg.startsWith('"') && msg.endsWith('"')) {
                msg = msg.slice(1, -1);
            }
            targetText.innerText = msg || "ì˜¤ëŠ˜ í•˜ë£¨ë„ ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤.";

            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                overlay.classList.add('opacity-100');
            }, 10);

            startFireworks(); // New JS-driven fireworks
            loadPlaylist();

            // Default: Auto-play Local BGM
            playLocalAudio();

            document.body.style.overflow = 'hidden';
        }

        function closeHealingOverlay() {
            const overlay = document.getElementById('healing-overlay');

            overlay.classList.remove('opacity-100');
            overlay.classList.add('opacity-0');

            // Stop ALL Audio
            stopAllAudio();

            // Stop Fireworks
            if (fireworkInterval) clearInterval(fireworkInterval);

            setTimeout(() => {
                overlay.classList.remove('flex');
                overlay.classList.add('hidden');
                document.getElementById('particles-container').innerHTML = '';
                document.body.style.overflow = '';
            }, 1000);
        }

        // --- Fireworks Logic ---
        // --- Firefly Logic (Healing Code) ---
        function startFireworks() { // Kept name for compatibility
            const container = document.getElementById('particles-container');
            container.innerHTML = '';

            // Initial population
            for (let i = 0; i < 750; i++) spawnFirefly(container);

            // Continuous spawning
            fireworkInterval = setInterval(() => {
                spawnFirefly(container);
            }, 12); // Ultra Dense stream
        }

        function spawnFirefly(container) {
            const fly = document.createElement('div');
            fly.className = 'absolute rounded-full pointer-events-none';

            // Visuals: Tiny, Yellow-Green Glow
            const size = Math.random() * 4 + 4; // 4px - 8px
            fly.style.width = `${size}px`;
            fly.style.height = `${size}px`;
            fly.style.backgroundColor = '#ccff00'; // Neon Lime/Yellow
            fly.style.boxShadow = `0 0 ${size + 4}px #ccff00`;
            fly.style.opacity = '0'; // Start hidden

            // Position: Random Screen
            const startX = Math.random() * 100;
            const startY = Math.random() * 100;
            fly.style.left = `${startX}%`;
            fly.style.top = `${startY}%`;

            container.appendChild(fly);

            // 1. Blinking Animation (Respiration)
            fly.animate([
                { opacity: 0 },
                { opacity: 0.8, offset: 0.5 },
                { opacity: 0 }
            ], {
                duration: 2000 + Math.random() * 3000,
                iterations: Infinity,
                direction: 'normal',
                easing: 'ease-in-out'
            });

            // 2. Floating Animation (Drift)
            const moveX = (Math.random() - 0.5) * 200;
            const moveY = (Math.random() - 0.5) * 150;

            const floatAnim = fly.animate([
                { transform: 'translate(0, 0)' },
                { transform: `translate(${moveX}px, ${moveY}px)` }
            ], {
                duration: 10000 + Math.random() * 10000, // 10s-20s
                fill: 'forwards',
                easing: 'linear'
            });

            floatAnim.onfinish = () => fly.remove();
        }

        function playLocalAudio() {
            currentSource = 'local';
            // Stop YT first
            if (ytPlayer && typeof ytPlayer.stopVideo === 'function') {
                ytPlayer.stopVideo(); // Stop completely to clear buffer
            }
            document.getElementById('yt-status').classList.add('hidden');

            // Play Local
            healingAudio.volume = 0.4;
            const promise = healingAudio.play();
            if (promise !== undefined) {
                promise.then(_ => {
                    isMusicPlaying = true;
                    updateAudioUI(true, 'Background Music');
                }).catch(e => {
                    isMusicPlaying = false;
                    updateAudioUI(false, 'Click to Play');
                });
            }
        }

        function playYouTube(videoId, title) {
            currentSource = 'youtube';
            // Stop Local first
            healingAudio.pause();

            // Play YT
            if (ytPlayer && isYtReady) {
                ytPlayer.loadVideoById(videoId);
                ytPlayer.setVolume(50);

                isMusicPlaying = true;
                updateAudioUI(true, `YouTube: ${title}`);
                document.getElementById('yt-status').classList.remove('hidden');
                document.getElementById('yt-status').innerText = `â–¶ YouTube Playing: ${title}`;
            } else {
                alert('YouTube í”Œë ˆì´ì–´ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                // Fallback
                playLocalAudio();
            }
        }

        function pauseAllAudio() {
            // Just pause, don't reset source
            if (currentSource === 'local') {
                healingAudio.pause();
            } else if (currentSource === 'youtube' && ytPlayer) {
                ytPlayer.pauseVideo();
            }
            isMusicPlaying = false;
            updateAudioUI(false, 'Paused (Click to Resume)');
        }

        function resumeAudio() {
            if (currentSource === 'local') {
                healingAudio.play();
                isMusicPlaying = true;
                updateAudioUI(true, 'Background Music');
            } else if (currentSource === 'youtube' && ytPlayer) {
                ytPlayer.playVideo();
                isMusicPlaying = true;
                // Keep existing title in UI if possible, or generic
                updateAudioUI(true, 'YouTube Playing');
            }
        }

        function stopAllAudio() {
            // For closing overlay
            healingAudio.pause();
            healingAudio.currentTime = 0;
            if (ytPlayer && typeof ytPlayer.stopVideo === 'function') {
                ytPlayer.stopVideo();
            }
            isMusicPlaying = false;
            updateAudioUI(false, 'Music Off');
        }

        function toggleAudio() {
            if (isMusicPlaying) {
                pauseAllAudio();
            } else {
                resumeAudio();
            }
        }

        function updateAudioUI(isPlaying, text) {
            const icon = document.getElementById('audio-icon');
            const label = document.getElementById('audio-label');
            if (isPlaying) {
                icon.innerText = 'ğŸ”Š';
                label.innerText = text || 'Music Playing';
            } else {
                icon.innerText = 'ğŸ”‡';
                label.innerText = text || 'Music Off';
            }
        }
    </script>
    </main>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        }

        function showPage(pageId) {
            // 1. Hide all sections
            document.querySelectorAll('.page-section').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('fade-in'); // Reset animation
            });

            // 2. Show target section
            const target = document.getElementById(pageId);
            if (target) {
                target.classList.remove('hidden');
                // Trigger reflow to restart animation
                target.offsetWidth; 
                target.classList.add('fade-in');
                window.scrollTo(0, 0);
            }

            // 3. Update Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(el => {
                // Reset style to default inactive
                el.className = 'nav-item flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-gray-300 hover:text-white transition cursor-pointer';
                
                // If matching target
                if (el.getAttribute('data-target') === pageId) {
                    el.className = 'nav-item flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-600/20 text-blue-400 font-bold border border-blue-500/30 transition hover:scale-105 active:scale-95';
                }
            });

            // Close mobile sidebar if open
            if (window.innerWidth < 1024) {
                 const sidebar = document.getElementById('sidebar');
                 if (!sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.add('-translate-x-full');
                }
            }
        }

        // Initialize: Show Dashboard by default
        document.addEventListener('DOMContentLoaded', () => {
            // Add 'page-section' class to likely sections if missing (Helper for migration)
            const sections = ['analytics-sales', 'analytics-forecast', 'analytics-menu', 'analytics-time', 'analytics-delivery', 'notifications', 'settings'];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('page-section', 'hidden');
                }
            });
            
            // Show dashboard
            showPage('section-dashboard');
        });
    </script>
</body>

</html>