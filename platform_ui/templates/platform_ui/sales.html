{% load static humanize %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ì¶œ ê´€ë¦¬ - Forkast AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-active {
            background-color: rgba(59, 130, 246, 0.2);
            border-bottom: 2px solid #3b82f6;
            color: #60a5fa;
        }

        /* Excel Sheet Style Table */
        .sheet-table th {
            background-color: #1f2937;
            color: #9ca3af;
            font-weight: normal;
            border: 1px solid #374151;
            padding: 8px;
            font-size: 0.875rem;
        }

        .sheet-table td {
            border: 1px solid #374151;
            padding: 8px;
            font-size: 0.875rem;
            color: #d1d5db;
        }

        .sheet-table tr:hover td {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen">

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 glass px-6 py-4 flex justify-between items-center bg-gray-900/90">
        <div class="flex items-center gap-4">
            <a href="{% url 'dashboard' %}" class="text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-arrow-left text-xl"></i>
            </a>
            <div class="text-xl font-bold text-blue-400">ë§¤ì¶œ ê´€ë¦¬ (Sales Management)</div>
        </div>
        <div class="text-sm text-gray-400">{{ today|date:"Y-m-d" }}</div>
    </nav>

    <div class="pt-24 pb-12 px-6 max-w-7xl mx-auto">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="glass p-6 rounded-xl border-l-4 border-blue-500">
                <h3 class="text-xs text-gray-400 uppercase font-bold mb-1">ì˜¤ëŠ˜ ì‹¤ë§¤ì¶œ</h3>
                <p class="text-2xl font-bold">â‚© {{ current_revenue|intcomma }}</p>
            </div>
            <div class="glass p-6 rounded-xl border-l-4 border-green-500">
                <h3 class="text-xs text-gray-400 uppercase font-bold mb-1">ì´ë²ˆ ë‹¬ ì˜ˆìƒ ìˆœìˆ˜ìµ</h3>
                <p class="text-2xl font-bold">â‚© {{ monthly_stats.profit|intcomma }}</p>
            </div>
            <div class="glass p-6 rounded-xl border-l-4 border-purple-500">
                <h3 class="text-xs text-gray-400 uppercase font-bold mb-1">AI ì˜ˆì¸¡ ì •í™•ë„</h3>
                <p class="text-2xl font-bold">94.2%</p>
            </div>
            <div class="glass p-6 rounded-xl border-l-4 border-gray-500 cursor-pointer hover:bg-white/5 transition"
                onclick="exportToExcel()">
                <h3 class="text-xs text-gray-400 uppercase font-bold mb-1">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
                <p class="text-lg font-bold flex items-center gap-2">
                    <i class="fa-solid fa-file-excel text-green-500"></i> Excel ë‹¤ìš´ë¡œë“œ
                </p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-700 mb-6">
            <button onclick="switchTab('today')" id="tab-today" class="px-6 py-3 font-medium transition tab-active">
                <i class="fa-regular fa-clock mr-2"></i>ì˜¤ëŠ˜ (ì‹œê°„ë³„)
            </button>
            <button onclick="switchTab('history')" id="tab-history"
                class="px-6 py-3 font-medium text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-list mr-2"></i>ê³¼ê±° ë§¤ì¶œ
            </button>
            <button onclick="switchTab('prediction')" id="tab-prediction"
                class="px-6 py-3 font-medium text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>ë¯¸ë˜ ì˜ˆìƒ (AI)
            </button>
            <button onclick="switchTab('monthly')" id="tab-monthly"
                class="px-6 py-3 font-medium text-gray-400 hover:text-white transition">
                <i class="fa-regular fa-calendar mr-2"></i>ì›”ë³„ ì§‘ê³„
            </button>
        </div>

        <!-- Content Area -->
        <div class="glass rounded-xl overflow-hidden min-h-[500px] relative">

            <!-- 1. Today's Hourly Sheet -->
            <div id="content-today" class="p-6 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">â±ï¸ ì˜¤ëŠ˜ì˜ ì‹œê°„ëŒ€ë³„ ë§¤ì¶œ í˜„í™©</h2>
                    <span class="text-xs text-gray-500">* POS ì‹¤ì‹œê°„ ì—°ë™ ë°ì´í„°</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse sheet-table" id="table-today">
                        <thead>
                            <tr>
                                <th class="w-24">ì‹œê°„</th>
                                <th>ë§¤ì¶œì•¡ (â‚©)</th>
                                <th>ëˆ„ì  ë§¤ì¶œì•¡ (â‚©)</th>
                                <th>ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in hourly_sales %}
                            <tr>
                                <td class="text-center bg-gray-800">{{ row.time }}</td>
                                <td class="text-right font-mono text-blue-300">{{ row.amount|intcomma }}</td>
                                <td class="text-right font-mono text-gray-400">{{ row.cumulative|intcomma }}</td>
                                <td></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center p-8">ì•„ì§ ë§¤ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2. Past History Sheet -->
            <div id="content-history" class="p-6 hidden fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">ğŸ“‹ ìµœê·¼ 30ì¼ ë§¤ì¶œ ê¸°ë¡</h2>
                    <span class="text-xs text-gray-500">* ë§ˆê° ì •ì‚° ë°ì´í„°</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse sheet-table" id="table-history">
                        <thead>
                            <tr>
                                <th class="w-32">ë‚ ì§œ</th>
                                <th class="w-24">ìš”ì¼</th>
                                <th>ì´ ë§¤ì¶œ (â‚©)</th>
                                <th>ë¹„ìš© (ì¬ë£Œ/ì¸ê±´ë¹„)</th>
                                <th>ìˆœìˆ˜ìµ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in history_data %}
                            <tr>
                                <td class="text-center bg-gray-800">{{ row.date|date:"Y-m-d" }}</td>
                                <td class="text-center">{{ row.day_of_week }}</td>
                                <td class="text-right font-mono text-blue-300">{{ row.revenue|intcomma }}</td>
                                <td class="text-right font-mono text-red-300">-{{ row.cost|intcomma }}</td>
                                <td class="text-right font-mono text-green-300">{{ row.profit|intcomma }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3. Predicted Sales Sheet -->
            <div id="content-prediction" class="p-6 hidden fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-purple-400">ğŸ”® í–¥í›„ 7ì¼ AI ì˜ˆìƒ ë§¤ì¶œ</h2>
                    <span class="text-xs text-gray-500">* ë‚ ì”¨/ì´ë²¤íŠ¸/íŠ¸ë Œë“œ ë°˜ì˜</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse sheet-table" id="table-prediction">
                        <thead>
                            <tr>
                                <th class="w-32">ì˜ˆì¸¡ ë‚ ì§œ</th>
                                <th class="w-24">ìš”ì¼</th>
                                <th>ì˜ˆìƒ ê¸°ìƒ</th>
                                <th>ì˜ˆìƒ ë§¤ì¶œ (â‚©)</th>
                                <th>AI ì‹ ë¢°ë„</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in prediction_data %}
                            <tr>
                                <td class="text-center bg-gray-800">{{ row.date|date:"Y-m-d" }}</td>
                                <td class="text-center">{{ row.day_of_week }}</td>
                                <td class="text-center">
                                    {% if row.weather_forecast == 'ë§‘ìŒ' %}â˜€ï¸{% elif row.weather_forecast == 'ë¹„' %}â˜”{%
                                    elif row.weather_forecast == 'ëˆˆ' %}â„ï¸{% else %}â˜ï¸{% endif %}
                                    {{ row.weather_forecast }}
                                </td>
                                <td class="text-right font-mono text-purple-300">{{ row.predicted_revenue|intcomma }}
                                </td>
                                <td class="text-right">
                                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                                        <div class="bg-purple-500 h-2.5 rounded-full"
                                            style="width: {{ row.confidence }}%"></div>
                                    </div>
                                    <span class="text-xs text-gray-400">{{ row.confidence }}%</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 4. Monthly Sheet -->
            <div id="content-monthly" class="p-6 hidden fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">ğŸ“… ì›”ê°„ í†µí•© ê´€ë¦¬</h2>
                    <span class="text-xs text-gray-500">* AI í•™ìŠµìš© ì§‘ê³„ ë°ì´í„°</span>
                </div>
                <div class="glass bg-gray-800 p-8 rounded-xl max-w-lg mx-auto text-center mt-8">
                    <h3 class="text-xl font-bold mb-6">ì´ë²ˆ ë‹¬ ëˆ„ì  í˜„í™©</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">ì´ ë§¤ì¶œ</span>
                            <span class="text-2xl font-bold text-blue-400">{{ monthly_stats.revenue|intcomma }}ì›</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">ì´ ë¹„ìš©</span>
                            <span class="text-xl font-bold text-red-400">-{{ monthly_stats.cost|intcomma }}ì›</span>
                        </div>
                        <div class="flex justify-between pt-2">
                            <span class="text-gray-400">ìˆœìˆ˜ìµ</span>
                            <span class="text-3xl font-bold text-green-400">{{ monthly_stats.profit|intcomma }}ì›</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        function switchTab(tabName) {
            // Hide all contents
            ['today', 'history', 'prediction', 'monthly'].forEach(t => {
                document.getElementById('content-' + t).classList.add('hidden');
                const btn = document.getElementById('tab-' + t);
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-400'); // Reset style
            });

            // Show selected
            document.getElementById('content-' + tabName).classList.remove('hidden');
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.add('tab-active');
            activeBtn.classList.remove('text-gray-400');
        }

        function exportToExcel() {
            // Simply export the History table as an example
            const wb = XLSX.utils.book_new();

            // Allow multiple sheet export logic here if needed
            const ws_history = XLSX.utils.table_to_sheet(document.getElementById('table-history'));
            XLSX.utils.book_append_sheet(wb, ws_history, "ê³¼ê±°ë§¤ì¶œ");

            const ws_today = XLSX.utils.table_to_sheet(document.getElementById('table-today'));
            XLSX.utils.book_append_sheet(wb, ws_today, "ì˜¤ëŠ˜ë§¤ì¶œ");

            XLSX.writeFile(wb, 'Forkast_Sales_Data.xlsx');
            alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.');
        }
    </script>
</body>

</html>