{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forkast - ì¬ê³  ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['Outfit', 'sans-serif'] },
                extend: {
                    colors: {
                        background: '#0f172a',
                        surface: '#1e293b',
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: white;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-good {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-low {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-over {
            background: rgba(234, 179, 8, 0.2);
            color: #facc15;
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        /* Modal Animation */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>

<body class="min-h-screen p-6">

    <!-- Header -->
    <header class="flex justify-between items-center mb-10 max-w-7xl mx-auto">
        <div class="flex items-center gap-4">
            <a href="{% url 'dashboard' %}" class="glass p-3 rounded-full hover:bg-white/10 transition">
                <i class="fa-solid fa-arrow-left text-xl"></i>
            </a>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">ì¬ê³ 
                ê´€ë¦¬ (Inventory)</h1>
        </div>
        <button onclick="openModal()"
            class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold shadow-lg shadow-blue-500/30 transition flex items-center gap-2">
            <i class="fa-solid fa-plus"></i> ìƒˆ í•­ëª© ì¶”ê°€
        </button>
    </header>

    <!-- Content -->
    <main class="max-w-7xl mx-auto">
        <div class="glass rounded-xl overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-white/5 border-b border-white/10 text-gray-400 uppercase text-sm">
                        <th class="p-6">ìƒí’ˆëª…</th>
                        <th class="p-6">í˜„ì¬ ì¬ê³ </th>
                        <th class="p-6">ì ì • ì¬ê³ </th>
                        <th class="p-6">ìƒíƒœ</th>
                        <th class="p-6 text-right">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="inventory-table-body" class="divide-y divide-white/5">
                    {% for item in inventory_items %}
                    <tr class="hover:bg-white/5 transition group">
                        <td class="p-6 font-semibold">{{ item.item_name }}</td>
                        <td class="p-6 font-mono text-xl">{{ item.current_stock }}</td>
                        <td class="p-6 text-gray-400">{{ item.optimal_stock }}</td>
                        <td class="p-6">
                            {% if item.status == 'GOOD' %}
                            <span class="status-badge status-good">ì ì •</span>
                            {% elif item.status == 'LOW' %}
                            <span class="status-badge status-low">ë¶€ì¡± (ë°œì£¼í•„ìš”)</span>
                            {% else %}
                            <span class="status-badge status-over">ê³¼ì‰</span>
                            {% endif %}
                        </td>
                        <td class="p-6 text-right opacity-50 group-hover:opacity-100 transition">
                            <button
                                onclick="editItem({{ item.id }}, '{{ item.item_name }}', {{ item.current_stock }}, {{ item.optimal_stock }})"
                                class="text-blue-400 hover:text-blue-300 mr-4">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="openOrderModal({{ item.id }}, '{{ item.item_name|escapejs }}')"
                                class="text-green-400 hover:text-green-300 mr-4" title="ë°œì£¼">
                                <i class="fa-solid fa-truck"></i>
                            </button>
                            <button onclick="deleteItem({{ item.id }})" class="text-red-400 hover:text-red-300">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="p-12 text-center text-gray-500">
                            ë“±ë¡ëœ ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤. 'ìƒˆ í•­ëª© ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if pending_orders %}
        <div class="mt-8 glass rounded-xl overflow-hidden p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-clock-rotate-left text-yellow-400"></i> ì…ê³  ëŒ€ê¸° í˜„í™© (Pending Orders)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for order in pending_orders %}
                <div class="bg-white/5 p-4 rounded-lg border border-white/10 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-lg">{{ order.item.item_name }}</div>
                        <div class="text-sm text-gray-400">
                            {{ order.created_at|date:"Y-m-d H:i" }} ìš”ì²­
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-xl font-mono text-yellow-400 font-bold">
                            +{{ order.quantity }}
                        </div>
                        <button onclick="confirmOrder({{ order.id }})"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded-lg text-sm font-bold transition shadow-lg shadow-blue-500/20">
                            ì…ê³  í™•ì¸
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </main>

    <!-- Modal -->
    <div id="itemModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass w-full max-w-md p-8 rounded-2xl border border-gray-700 shadow-2xl transform transition-all scale-95"
            id="modalContent">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6">ìƒˆ í•­ëª© ì¶”ê°€</h2>
            <form id="inventoryForm">
                <input type="hidden" id="itemId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">ìƒí’ˆëª…</label>
                        <input type="text" id="itemName"
                            class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-3 focus:border-blue-500 focus:outline-none transition"
                            placeholder="ì˜ˆ: ì›ë‘" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">í˜„ì¬ ì¬ê³ </label>
                            <input type="number" id="currentStock"
                                class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-3 focus:border-blue-500 focus:outline-none transition"
                                placeholder="0" required>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">ì ì • ì¬ê³ </label>
                            <input type="number" id="optimalStock"
                                class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-3 focus:border-blue-500 focus:outline-none transition"
                                placeholder="0" required>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-8">
                    <button type="button" onclick="closeModal()"
                        class="px-5 py-2 rounded-lg hover:bg-white/10 transition">ì·¨ì†Œ</button>
                    <button type="submit"
                        class="px-5 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold shadow-lg shadow-blue-500/20 transition">ì €ì¥í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass w-full max-w-sm p-8 rounded-2xl border border-gray-700 shadow-2xl transform transition-all scale-95"
            id="orderModalContent">
            <h2 class="text-2xl font-bold mb-2">ğŸ“¦ ë¹ ë¥¸ ë°œì£¼</h2>
            <p id="orderItemName" class="text-gray-400 mb-6 font-medium">ìƒí’ˆëª…</p>

            <form id="orderForm">
                <input type="hidden" id="orderItemId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">ë°œì£¼ ìˆ˜ëŸ‰</label>
                        <input type="number" id="orderQuantity"
                            class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-3 focus:border-green-500 focus:outline-none transition text-xl font-bold"
                            placeholder="10" value="10" min="1" required>
                        <p class="text-xs text-gray-500 mt-2">* V1 ë²„ì „ì—ì„œëŠ” ë°œì£¼ ì‹œ ì¦‰ì‹œ ì¬ê³ ê°€ ì…ê³ ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-8">
                    <button type="button" onclick="closeOrderModal()"
                        class="px-5 py-2 rounded-lg hover:bg-white/10 transition">ì·¨ì†Œ</button>
                    <button type="submit"
                        class="px-5 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold shadow-lg shadow-green-500/20 transition flex items-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i> ë°œì£¼í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById('itemModal');
        const modalContent = document.getElementById('modalContent');
        const form = document.getElementById('inventoryForm');

        // Order Modal Elements
        const orderModal = document.getElementById('orderModal');
        const orderModalContent = document.getElementById('orderModalContent');
        const orderForm = document.getElementById('orderForm');

        function openModal() {
            document.getElementById('modalTitle').innerText = 'ìƒˆ í•­ëª© ì¶”ê°€';
            document.getElementById('itemId').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('currentStock').value = '';
            document.getElementById('optimalStock').value = '';

            modal.classList.add('active');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }

        function closeModal() {
            modal.classList.remove('active');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
        }

        function editItem(id, name, current, optimal) {
            document.getElementById('modalTitle').innerText = 'ì¬ê³  ìˆ˜ì •';
            document.getElementById('itemId').value = id;
            document.getElementById('itemName').value = name;
            document.getElementById('currentStock').value = current;
            document.getElementById('optimalStock').value = optimal;

            modal.classList.add('active');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }

        // --- Order Logic ---
        function openOrderModal(id, name) {
            document.getElementById('orderItemId').value = id;
            document.getElementById('orderItemName').innerText = name + " ë°œì£¼ ì‹ ì²­";
            document.getElementById('orderQuantity').value = 10; // Default

            orderModal.classList.add('active');
            orderModalContent.classList.remove('scale-95');
            orderModalContent.classList.add('scale-100');

            // Auto focus
            setTimeout(() => document.getElementById('orderQuantity').select(), 100);
        }

        function closeOrderModal() {
            orderModal.classList.remove('active');
            orderModalContent.classList.remove('scale-100');
            orderModalContent.classList.add('scale-95');
        }

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('orderItemId').value;
            const quantity = document.getElementById('orderQuantity').value;

            try {
                const response = await fetch("{% url 'order_api' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ item_id: id, quantity: quantity })
                });

                if (response.ok) {
                    alert('ë°œì£¼ê°€ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.\ní•˜ë‹¨ [ì…ê³  ëŒ€ê¸° í˜„í™©]ì—ì„œ ì…ê³ ë¥¼ í™•ì •í•´ì£¼ì„¸ìš”.');
                    location.reload();
                } else {
                    const res = await response.json();
                    alert('ë°œì£¼ ì‹¤íŒ¨: ' + (res.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        async function confirmOrder(orderId) {
            if (!confirm('ë¬¼í’ˆì´ ì…ê³ ë˜ì—ˆìŠµë‹ˆê¹Œ?\ní™•ì¸ ì‹œ ì¬ê³ ê°€ ì¦ê°€í•©ë‹ˆë‹¤.')) return;

            try {
                const response = await fetch("{% url 'order_api' %}", {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ order_id: orderId })
                });

                if (response.ok) {
                    alert('ì…ê³ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ì¬ê³  ë°˜ì˜ë¨)');
                    location.reload();
                } else {
                    const res = await response.json();
                    alert('ì²˜ë¦¬ ì‹¤íŒ¨: ' + (res.message || 'ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('itemId').value;
            const data = {
                id: id ? id : null,
                item_name: document.getElementById('itemName').value,
                current_stock: document.getElementById('currentStock').value,
                optimal_stock: document.getElementById('optimalStock').value
            };

            try {
                const response = await fetch("{% url 'inventory_api' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        async function deleteItem(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch("{% url 'inventory_api' %}", {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ id: id })
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>

</html>